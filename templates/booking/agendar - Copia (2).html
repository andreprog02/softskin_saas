{% extends "base.html" %}
{% load static %}
{% block title %}Agendamento - {{ salao.nome }}{% endblock %}
{% block content %}
{{ servicos|json_script:"SERVICOS_JSON" }}
{{ profissionais|json_script:"PROFISSIONAIS_JSON" }}
{{ feriados|default:"[]"|json_script:"FERIADOS_JSON" }}
{{ folgas|default:"[]"|json_script:"FOLGAS_JSON" }}
{{ dias_fechados|default:"[]"|json_script:"DIAS_FECHADOS_JSON" }}
<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agendamento - {{ salao.nome }}</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    
    {% if turnstile_site_key %}
    <script src="https://challenges.cloudflare.com/turnstile/v0/api.js?onload=turnstileOnload" async defer></script>
    {% endif %}
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    
    <style>
        :root {
            --cor-primaria: #D81B60; /* Rosa elegante */
            --cor-primaria-clara: color-mix(in srgb, var(--cor-primaria), white 80%);
            --cor-primaria-escura: color-mix(in srgb, var(--cor-primaria), black 20%);
            --cor-secundaria: #2C3E50; /* Cinza escuro elegante */
            --cor-acentuada: #FDF2F8; /* Fundo rosa claro suave */
            --cor-sucesso: #10B981;
            --cor-erro: #EF4444;
            --cor-aviso: #F59E0B;
            --shadow-soft: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-elevated: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05);
        }
        .bg-theme { background-color: var(--cor-primaria); }
        .bg-theme-light { background-color: var(--cor-primaria-clara); }
        .bg-theme-dark { background-color: var(--cor-primaria-escura); }
        .text-theme { color: var(--cor-primaria); }
        .border-theme { border-color: var(--cor-primaria); }
        body { font-family: 'Inter', sans-serif; background-color: var(--cor-acentuada); color: var(--cor-secundaria); margin: 0; padding: 0; }
        .gradient-bg { background: linear-gradient(135deg, var(--cor-primaria) 0%, var(--cor-primaria-escura) 100%); }
        .selected-card { border-color: var(--cor-primaria) !important; background-color: var(--cor-primaria-clara); box-shadow: var(--shadow-elevated); transform: scale(1.02); }
        .slot-btn { border: 2px solid var(--cor-acentuada); transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .slot-btn:hover:not(:disabled) { border-color: var(--cor-primaria); color: var(--cor-primaria); transform: translateY(-4px) scale(1.05); box-shadow: var(--shadow-soft); }
        .slot-selected { background-color: var(--cor-primaria) !important; color: white !important; border-color: var(--cor-primaria) !important; transform: scale(1.05); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .prof-img-container.selected-prof { border-color: var(--cor-primaria) !important; background-color: var(--cor-primaria-clara); transform: scale(1.1); box-shadow: var(--shadow-elevated); }
        .cat-btn.active { background-color: var(--cor-primaria); color: white; border-color: var(--cor-primaria); transform: scale(1.05); }
        .calendar-day.disabled { opacity: 0.4 !important; cursor: not-allowed !important; pointer-events: none !important; background-color: #e5e7eb !important; text-decoration: line-through; color: #9ca3af !important; }
        .day-selected { background-color: var(--cor-primaria) !important; color: white !important; border-color: var(--cor-primaria) !important; transform: scale(1.05); }
        @keyframes modalPop { 0% { transform: scale(0.95) rotate(-1deg); opacity: 0; } 100% { transform: scale(1) rotate(0); opacity: 1; } }
        .animate-pop { animation: modalPop 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        .hover-glow { transition: box-shadow 0.3s; }
        .hover-glow:hover { box-shadow: 0 0 15px rgba(var(--cor-primaria-rgb), 0.3); }
        .stepper-line { background: var(--cor-acentuada); height: 2px; }
        .step.active span { background-color: var(--cor-primaria) !important; color: white !important; }
        .step.completed span { background-color: var(--cor-primaria-clara); color: var(--cor-primaria); }
        .line-completed { background: var(--cor-primaria) !important; }
        .tooltip { position: relative; }
        .tooltip::after { content: attr(data-tooltip); position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%); background: var(--cor-secundaria); color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px; white-space: nowrap; opacity: 0; transition: opacity 0.2s; pointer-events: none; }
        .tooltip:hover::after { opacity: 1; }
        .calendar-grid button { transition: all 0.3s; }
        .calendar-grid button:hover:not(.disabled) { background-color: var(--cor-primaria-clara); color: var(--cor-primaria); border-color: var(--cor-primaria); box-shadow: var(--shadow-soft); transform: translateY(-2px); }
        .input-focus { transition: ring 0.3s; }
        .input-focus:focus { ring: 4px solid var(--cor-primaria-clara); box-shadow: 0 0 0 4px var(--cor-primaria-clara); }
    </style>
</head>
<body>
    <div style="position: fixed; top: 0; left: 0; z-index: 0; pointer-events: none; opacity: 0;">
        <div id="voucher-template" style="width: 400px; background: white; border-radius: 0 0 32px 0; overflow: hidden; font-family: 'Inter', sans-serif; box-shadow: var(--shadow-elevated);">
            
            <div class="gradient-bg p-8 text-center text-white relative">
                <h2 class="text-2xl font-extrabold uppercase tracking-widest mb-2">{{ salao.nome }}</h2>
                <p class="text-xs uppercase tracking-[0.3em] opacity-80">Comprovante Premium</p>
            </div>
            <div class="p-10 bg-white text-gray-800 pb-8">
                <div class="text-center space-y-2 mb-8">
                    <p class="text-xs text-gray-400 uppercase font-bold tracking-wider">Cliente Premium</p>
                    <p class="text-3xl font-black text-gray-900 leading-none" id="v-nome">Cliente</p>
                    <p class="text-sm text-gray-500 font-mono" id="v-tel">---</p>
                </div>
                
                <div class="border-t-4 border-dashed border-gray-200 my-8"></div>
                
                <div class="grid grid-cols-2 gap-6 text-center">
                    <div><p class="text-xs text-gray-400 uppercase font-bold tracking-wider">Data</p><p class="text-xl font-black text-theme" id="v-data">--/--</p></div>
                    <div><p class="text-xs text-gray-400 uppercase font-bold tracking-wider">Horário</p><p class="text-xl font-black text-theme" id="v-hora">--:--</p></div>
                </div>
                
                <div class="text-center mt-8">
                    <p class="text-xs text-gray-400 uppercase font-bold tracking-wider">Serviço Exclusivo</p>
                    <p class="text-base font-bold text-gray-800" id="v-servico">Serviço</p>
                </div>
                
                <div class="mt-10 flex flex-col items-center">
                    <p class="text-xs text-gray-400 uppercase font-bold tracking-wider mb-3">Código de Validação QR</p>
                    <div class="bg-gray-100 p-4 rounded-2xl border-2 border-dashed border-gray-200" id="qrcode-voucher"></div>
                </div>
            </div>
            <div class="bg-gray-50 px-8 py-6 border-t border-gray-100 text-center space-y-4">
                
                {% if salao.telefone %}
                <p class="text-sm font-bold text-gray-700 flex items-center justify-center gap-2">
                    <span class="material-icons text-theme text-xl">phone</span>
                    {{ salao.telefone }}
                </p>
                {% endif %}
                {% if endereco %}
                <div class="text-xs text-gray-500 leading-tight">
                    <p class="font-semibold text-gray-600 mb-1">Localização Premium:</p>
                    <p>
                        {% if endereco.logradouro %}{{ endereco.logradouro }}{% endif %}
                        {% if endereco.numero %}, {{ endereco.numero }}{% endif %}
                        {% if endereco.complemento %} - {{ endereco.complemento }}{% endif %}
                    </p>
                    <p>
                        {% if endereco.bairro %}{{ endereco.bairro }}{% endif %}
                        {% if endereco.cidade %} - {{ endereco.cidade }}{% endif %}
                    </p>
                </div>
                {% endif %}
            </div>
            <div class="h-3 gradient-bg"></div>
        </div>
    </div>
    <div id="main-wrapper" style="position: relative; z-index: 10; background-color: var(--cor-acentuada); min-height: 100vh; width: 100%;">
        <div class="p-6 md:p-10">
            <div class="max-w-3xl mx-auto bg-white rounded-[4rem] shadow-2xl overflow-hidden pb-16 relative">
                <div class="gradient-bg p-12 text-white text-center">
                    <h1 class="text-4xl font-extrabold tracking-tight uppercase">{{ salao.nome }}</h1>
                    <p class="opacity-90 mt-3 font-medium text-lg">Reserve seu momento de luxo agora</p>
                </div>
                <!-- Stepper Progress -->
                <div class="flex justify-center mt-8 mb-12">
                    <div class="w-full max-w-md flex items-center justify-between px-8">
                        <div class="step step-1 flex flex-col items-center">
                            <span class="w-10 h-10 rounded-full bg-theme-light text-theme flex items-center justify-center font-black text-xl">1</span>
                            <p class="text-xs mt-2 text-gray-500">Serviço</p>
                        </div>
                        <div class="flex-1 stepper-line mx-2 line-1"></div>
                        <div class="step step-2 flex flex-col items-center">
                            <span class="w-10 h-10 rounded-full bg-theme-light text-theme flex items-center justify-center font-black text-xl">2</span>
                            <p class="text-xs mt-2 text-gray-500">Profissional</p>
                        </div>
                        <div class="flex-1 stepper-line mx-2 line-2"></div>
                        <div class="step step-3 flex flex-col items-center">
                            <span class="w-10 h-10 rounded-full bg-theme-light text-theme flex items-center justify-center font-black text-xl">3</span>
                            <p class="text-xs mt-2 text-gray-500">Data & Hora</p>
                        </div>
                        <div class="flex-1 stepper-line mx-2 line-3"></div>
                        <div class="step step-4 flex flex-col items-center">
                            <span class="w-10 h-10 rounded-full bg-theme-light text-theme flex items-center justify-center font-black text-xl">4</span>
                            <p class="text-xs mt-2 text-gray-500">Finalizar</p>
                        </div>
                    </div>
                </div>
                <div class="p-8 md:p-12 space-y-16">
                    <section>
                        <div class="flex items-center space-x-4 mb-8">
                            <span class="bg-theme-light text-theme w-10 h-10 rounded-full flex items-center justify-center font-black italic">1</span>
                            <h3 class="text-gray-800 uppercase text-sm font-black tracking-widest">Escolha o Serviço Premium</h3>
                        </div>
                        {% if categorias %}
                        <div class="mb-8 overflow-x-auto no-scrollbar py-3 -mx-3 px-3">
                            <div class="flex gap-3">
                                {% for cat in categorias %}
                                <button onclick="filtrarCategoria(this)" data-id="{{ cat.id }}" class="cat-btn border border-gray-200 px-6 py-3 rounded-full text-sm font-bold text-gray-500 whitespace-nowrap hover:bg-gray-50 hover-glow transition-all">{{ cat.nome }}</button>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6" id="grid-servicos">
                            {% for servico in servicos %}
                            <div class="service-card relative flex items-center p-6 border-2 rounded-3xl cursor-pointer hover:border-theme hover-glow transition-all border-gray-100 shadow-sm animate-pop hover:transform hover:scale-105"
                                 data-cat="{{ servico.category_id|default:'sem-categoria' }}"
                                 onclick="selecionarServico('{{ servico.id }}', '{{ servico.nome }}', this)">
                                <div class="flex-1">
                                    <span class="block font-bold text-xl text-gray-800">{{ servico.nome }}</span>
                                    <div class="flex items-center gap-1 text-sm text-gray-400 font-bold uppercase">
                                        <span class="material-icons text-theme">access_time</span>
                                        {{ servico.duracao_minutos }} min
                                    </div>
                                </div>
                                {% if not salao.ocultar_precos %}<span class="font-black text-theme text-lg">R$ {{ servico.preco|floatformat:2 }}</span>{% endif %}
                            </div>
                            {% endfor %}
                        </div>
                        <div id="msg-sem-servico" class="hidden text-center text-gray-400 py-12 italic text-lg">Nenhum serviço nesta categoria premium.</div>
                    </section>
                    <section id="section-profissionais" class="hidden transition-all duration-700 ease-in-out">
                        <div class="flex items-center space-x-4 mb-8">
                            <span class="bg-theme-light text-theme w-10 h-10 rounded-full flex items-center justify-center font-black italic">2</span>
                            <h3 class="text-gray-800 uppercase text-sm font-black tracking-widest">Selecione o Profissional Especialista</h3>
                        </div>
                        <div id="lista-profissionais" class="flex space-x-8 overflow-x-auto no-scrollbar py-4">
                            <p class="text-gray-400 italic text-md ml-4">Selecione o serviço acima para ver especialistas...</p>
                        </div>
                    </section>
                    <section id="section-calendario" class="hidden transition-all duration-700 ease-in-out">
                        <div class="flex items-center justify-between mb-8">
                            <div class="flex items-center space-x-4">
                                <span class="bg-theme-light text-theme w-10 h-10 rounded-full flex items-center justify-center font-black italic">3</span>
                                <h3 class="text-gray-800 uppercase text-sm font-black tracking-widest">Escolha a Data Ideal</h3>
                            </div>
                            <span id="label-mes-ano" class="text-md font-bold text-theme bg-theme-light px-4 py-2 rounded-xl"></span>
                        </div>
                        <div class="bg-gray-50 p-8 rounded-[3rem] border-2 border-gray-100 shadow-md">
                            <div id="calendar-grid" class="grid grid-cols-7 gap-4 text-center text-md calendar-grid"></div>
                        </div>
                    </section>
                    <section id="section-horarios" class="border-t border-gray-100 pt-12 hidden transition-all duration-700">
                        <div id="lista-horarios" class="grid grid-cols-3 md:grid-cols-5 gap-4"></div>
                    </section>
                    <section id="section-finalizar" class="hidden border-t border-gray-200 pt-12 transition-all duration-700">
                        <div class="bg-gray-50 p-10 rounded-[3rem] border-2 border-dashed border-gray-200 shadow-lg">
                            <div class="space-y-6">
                                <input type="text" id="cliente-nome" placeholder="Seu nome completo" class="w-full p-6 rounded-3xl border-none font-bold shadow-sm outline-none focus:ring-4 focus:ring-theme-light input-focus">
                                <input type="tel" id="cliente-whatsapp" maxlength="16" placeholder="(00) 0 0000-0000" class="w-full p-6 rounded-3xl border-none font-bold shadow-sm outline-none focus:ring-4 focus:ring-theme-light input-focus">
                                <div id="turnstile-widget" class="hidden"></div>
                                <button onclick="finalizarReserva()" id="btn-confirmar" class="w-full gradient-bg text-white font-black py-6 rounded-3xl shadow-xl transition-all mt-6 tracking-widest uppercase hover:opacity-90 hover:transform hover:scale-105 hover-glow">Confirmar Agendamento Premium</button>
                            </div>
                        </div>
                    </section>
                </div>
            </div>
        </div>
    </div>
    <div id="modal-sucesso" class="hidden fixed inset-0 z-50 flex items-center justify-center p-6 backdrop-blur-md">
        <div class="absolute inset-0 bg-black/70 transition-opacity"></div>
        <div class="relative bg-white rounded-4xl overflow-hidden shadow-2xl w-full max-w-md transform animate-pop flex flex-col items-center z-50">
            <div class="w-full p-8 text-center bg-gray-50 border-b border-gray-100">
                <div class="w-20 h-20 rounded-full bg-green-100 flex items-center justify-center mx-auto mb-4">
                    <span class="material-icons text-6xl text-sucesso">check_circle</span>
                </div>
                <h3 class="text-2xl font-black text-gray-800">Agendamento Confirmado com Sucesso!</h3>
                <p class="text-sm text-gray-500 mt-2">Seu horário premium foi reservado.</p>
            </div>
            <div id="loading-ticket" class="p-12 flex flex-col items-center">
                <div class="w-10 h-10 border-4 border-theme border-t-transparent rounded-full animate-spin"></div>
                <p class="text-sm text-gray-400 mt-4 font-bold uppercase tracking-widest">Gerando Voucher Exclusivo...</p>
            </div>
            <div id="area-ticket-pronto" class="hidden p-8 w-full flex justify-center bg-gray-100 border-b border-gray-100">
                <img id="img-ticket-gerado" class="rounded-2xl shadow-lg w-[320px] h-auto border border-gray-200 block mx-auto" alt="Voucher Premium">
            </div>
            <div class="p-8 w-full space-y-4 bg-white">
                <a id="btn-download-ticket" href="#" class="block w-full text-center gradient-bg text-white font-bold py-4 rounded-2xl shadow-lg hover:opacity-90 transition-transform active:scale-95 flex items-center justify-center gap-3 cursor-pointer decoration-0"><span class="material-icons">download</span>Baixar Voucher</a>
                <button onclick="location.reload()" class="block w-full text-center text-gray-500 font-bold py-4 rounded-2xl hover:bg-gray-50 transition flex items-center justify-center gap-3"><span class="material-icons">add_circle</span>Novo Agendamento</button>
            </div>
        </div>
    </div>
    <div id="modal-erro" class="hidden fixed inset-0 z-50 flex items-center justify-center p-6 backdrop-blur-md">
        <div class="absolute inset-0 bg-black/60 transition-opacity" onclick="fecharModalErro()"></div>
        <div class="relative bg-white rounded-4xl overflow-hidden shadow-2xl w-full max-w-md transform animate-pop z-50">
            <div class="h-4 bg-erro w-full"></div>
            <div class="p-10 text-center flex flex-col items-center gap-6">
                <span class="material-icons text-8xl text-erro">error_outline</span>
                <h3 class="text-3xl font-black text-gray-800">Ops! Algo deu errado.</h3>
                <p id="msg-erro-texto" class="text-gray-500 font-medium leading-relaxed text-lg">Tente novamente ou contate o suporte.</p>
                <button onclick="fecharModalErro()" class="w-full bg-erro text-white font-bold py-5 rounded-2xl shadow-lg shadow-red-200 mt-6 hover:bg-red-600 transition-colors active:scale-95">Tentar Novamente</button>
            </div>
        </div>
    </div>
    <script>
        function getJsonData(id) {
            try {
                const el = document.getElementById(id);
                return el ? JSON.parse(el.textContent) : [];
            } catch (e) { return []; }
        }
        const SERVICOS = getJsonData('SERVICOS_JSON');
        const PROFISSIONAIS_ALL = getJsonData('PROFISSIONAIS_JSON');
        const rawFeriados = getJsonData('FERIADOS_JSON');
        const FERIADOS = Array.isArray(rawFeriados) ? rawFeriados : [];
        const rawFolgas = getJsonData('FOLGAS_JSON');
        const FOLGAS = Array.isArray(rawFolgas) ? rawFolgas : [];
        const rawDias = getJsonData('DIAS_FECHADOS_JSON');
        const DIAS_FECHADOS = Array.isArray(rawDias) ? rawDias : [];
        
        const SLUG = "{{ salao.slug }}";
        const BASE_URL = "/agendar/saloes/" + SLUG;
        const THEME_HEX = (getComputedStyle(document.documentElement).getPropertyValue('--cor-primaria').trim().replace('#','') || 'D81B60');
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        let selectedService = null;
        let selectedServiceName = "Serviço";
        let selectedProfessional = null;
        let selectedDate = null;
        let selectedTime = null;
        let mesAtual = new Date();
        window.addEventListener('DOMContentLoaded', () => {
            const firstCatBtn = document.querySelector('.cat-btn');
            if(firstCatBtn) filtrarCategoria(firstCatBtn);
            updateStepper(1);
        });
        function updateStepper(currentStep) {
            for (let i = 1; i <= 4; i++) {
                const stepEl = document.querySelector(`.step-${i}`);
                const spanEl = stepEl.querySelector('span');
                spanEl.classList.remove('bg-theme', 'text-white');
                spanEl.classList.add('bg-theme-light', 'text-theme');
                stepEl.classList.remove('active', 'completed');
                if (i < currentStep) {
                    stepEl.classList.add('completed');
                } else if (i === currentStep) {
                    stepEl.classList.add('active');
                    spanEl.classList.remove('bg-theme-light', 'text-theme');
                    spanEl.classList.add('bg-theme', 'text-white');
                }
                if (i < 4) {
                    const lineEl = document.querySelector(`.line-${i}`);
                    if (i < currentStep) {
                        lineEl.classList.add('line-completed');
                    } else {
                        lineEl.classList.remove('line-completed');
                    }
                }
            }
        }
        function filtrarCategoria(btn) {
            if(!btn) return;
            
            // Resetar estado
            resetarEstado(1);
            
            // Visual botões
            document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            
            // Filtrar serviços
            const catId = btn.dataset.id;
            const cards = document.querySelectorAll('.service-card');
            let visibleCount = 0;
            cards.forEach(card => {
                if (card.dataset.cat === catId) {
                    card.style.display = 'flex';
                    visibleCount++;
                    card.classList.remove('animate-pop');
                    void card.offsetWidth;
                    card.classList.add('animate-pop');
                } else {
                    card.style.display = 'none';
                }
            });
            document.getElementById('msg-sem-servico').style.display = (visibleCount === 0) ? 'block' : 'none';
            
            document.getElementById('section-profissionais').classList.add('hidden');
        }
        function resetarEstado(nivel) {
            if (nivel === 1) {
                selectedService = null;
                selectedServiceName = null;
                document.querySelectorAll('.service-card').forEach(c => c.classList.remove('selected-card'));
            }
            if (nivel <= 2) {
                selectedProfessional = null;
                document.querySelectorAll('.prof-img-container').forEach(c => c.classList.remove('selected-prof', 'border-theme', 'scale-110'));
                document.getElementById('section-calendario').classList.add('hidden');
                if (nivel === 1) {
                    const listaProf = document.getElementById('lista-profissionais');
                    if(listaProf) listaProf.innerHTML = '<p class="text-gray-400 italic text-md ml-4">Selecione o serviço acima para ver especialistas...</p>';
                }
            }
            selectedDate = null;
            selectedTime = null;
            document.getElementById('section-horarios').classList.add('hidden');
            document.getElementById('section-finalizar').classList.add('hidden');
            document.getElementById('lista-horarios').innerHTML = '';
            document.querySelectorAll('.day-selected').forEach(d => d.classList.remove('day-selected'));
            updateStepper(1); // Reset to step 1 on full reset
        }
        function selecionarServico(id, nome, cardEl) {
            resetarEstado(2);
            selectedService = id;
            selectedServiceName = nome;
            document.querySelectorAll('.service-card').forEach(c => c.classList.remove('selected-card'));
            cardEl.classList.add('selected-card');
            const container = document.getElementById('lista-profissionais');
            container.innerHTML = '';
            const profsFiltrados = PROFISSIONAIS_ALL.filter(p => p.servicos.includes(parseInt(id)));
            if (profsFiltrados.length === 0) {
                container.innerHTML = '<p class="text-aviso font-bold text-md ml-4">Nenhum especialista disponível para este serviço premium.</p>';
            } else {
                profsFiltrados.forEach(p => {
                    const div = document.createElement('div');
                    div.className = "prof-card flex-shrink-0 text-center w-32 cursor-pointer group";
                    let imgHtml = p.foto
                        ? `<img src="${p.foto}" class="rounded-full w-full h-full object-cover">`
                        : `<img src="https://ui-avatars.com/api/?name=${encodeURIComponent(p.nome)}&background=${THEME_HEX}&color=fff&bold=true" class="rounded-full w-full h-full">`;
                    div.innerHTML = `
                        <div class="prof-img-container w-28 h-28 mx-auto rounded-full bg-white mb-4 border-4 border-gray-100 transition-all shadow-md flex items-center justify-center overflow-hidden hover-glow" data-pid="${p.id}">
                            ${imgHtml}
                        </div>
                        <span class="block text-sm font-black uppercase text-gray-500">${p.nome}</span>
                    `;
                    div.onclick = () => {
                        selecionarProfissionalUI(p.id, div);
                    };
                    container.appendChild(div);
                });
            }
            const sectionProf = document.getElementById('section-profissionais');
            sectionProf.classList.remove('hidden');
            sectionProf.scrollIntoView({behavior:'smooth', block: 'center'});
            updateStepper(2);
        }
        function selecionarProfissionalUI(pid, divEl) {
            resetarEstado(3);
            selectedProfessional = pid;
            document.querySelectorAll('.prof-img-container').forEach(c => c.classList.remove('selected-prof', 'border-theme', 'scale-110'));
            divEl.querySelector('.prof-img-container').classList.add('selected-prof', 'border-theme', 'scale-110');
            document.getElementById('section-calendario').classList.remove('hidden');
            renderizarCalendario();
            document.getElementById('section-calendario').scrollIntoView({behavior:'smooth'});
            updateStepper(3);
        }
        function renderizarCalendario() {
            try {
                const grid = document.getElementById('calendar-grid');
                grid.innerHTML = '';
                const diasS = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb'];
                diasS.forEach(d => grid.innerHTML += `<div class="font-black text-gray-300 text-sm pb-3">${d}</div>`);
                const hoje = new Date();
                hoje.setHours(0,0,0,0);
                const ano = mesAtual.getFullYear();
                const mes = mesAtual.getMonth();
                const meses = ["Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
                document.getElementById('label-mes-ano').innerHTML = `
                    <button onclick="mudarMes(-1)" class="px-3 text-2xl hover:text-theme transition-all">‹</button>
                    <span class="mx-3 text-lg">${meses[mes]} ${ano}</span>
                    <button onclick="mudarMes(1)" class="px-3 text-2xl hover:text-theme transition-all">›</button>
                `;
                const primeiroDiaExibido = new Date(ano, mes, 1).getDay();
                const diasNoMes = new Date(ano, mes + 1, 0).getDate();
                for (let j = 0; j < primeiroDiaExibido; j++) { grid.appendChild(document.createElement('div')); }
                const profDados = PROFISSIONAIS_ALL.find(p => p.id === selectedProfessional);
                const diasTrabalhoProf = (profDados && profDados.dias_trabalho) ? profDados.dias_trabalho : [0,1,2,3,4,5,6];
                const folgasProf = (profDados && profDados.folgas) ? profDados.folgas : [];
                let bloqueios = {
                    feriados: FERIADOS.map(f => f.data || f),
                    dias_recorrentes: DIAS_FECHADOS
                };
                for (let d = 1; d <= diasNoMes; d++) {
                    const data = new Date(ano, mes, d);
                    const iso = data.toISOString().split('T')[0];
                    const jsDay = data.getDay();
                    const pythonDay = { 0: 6, 1: 0, 2: 1, 3: 2, 4: 3, 5: 4, 6: 5 }[jsDay];
                    const ehPassado = data < hoje;
                    const ehFeriado = bloqueios.feriados.includes(iso);
                    const ehDiaFechadoSalao = bloqueios.dias_recorrentes.includes(pythonDay);
                    const profNaoTrabalha = !diasTrabalhoProf.includes(pythonDay);
                    const ehFolgaProf = folgasProf.includes(iso);
                    const estaBloqueado = ehPassado || ehFeriado || ehDiaFechadoSalao || profNaoTrabalha || ehFolgaProf;
                    const btn = document.createElement('button');
                    btn.innerText = d;
                    btn.className = `p-4 rounded-2xl font-bold transition-all flex flex-col items-center justify-center h-14 shadow-md border border-gray-100 hover-glow`;
                    if (estaBloqueado) {
                        btn.className += ` calendar-day disabled`;
                        btn.disabled = true;
                    } else {
                        btn.className += ` bg-white text-gray-700 hover:bg-theme-light hover:text-theme hover:border-theme cursor-pointer`;
                        if (selectedDate === iso) btn.classList.add('day-selected');
                        btn.onclick = () => {
                            selectedDate = iso;
                            renderizarCalendario();
                            buscarHorarios(iso);
                        };
                    }
                    grid.appendChild(btn);
                }
            } catch(e) { console.error("Erro renderizarCalendario:", e); }
        }
        function mudarMes(delta) {
            mesAtual.setMonth(mesAtual.getMonth() + delta);
            renderizarCalendario();
        }
        async function buscarHorarios(iso) {
            const container = document.getElementById('lista-horarios');
            document.getElementById('section-horarios').classList.remove('hidden');
            container.innerHTML = '<p class="col-span-full text-center text-theme font-bold p-6 text-lg">Consultando horários premium...</p>';
            try {
                const res = await fetch(`${BASE_URL}/disponibilidade/${iso}?service_id=${selectedService}&professional_id=${selectedProfessional}`);
                const data = await res.json();
                const profData = data.find(p => p.professional_id == selectedProfessional);
                container.innerHTML = '';
                if (!profData || !profData.horarios || profData.horarios.length === 0) {
                    container.innerHTML = '<p class="col-span-full text-center text-gray-400 font-bold p-6 bg-gray-50 rounded-3xl italic text-lg">Nenhum horário premium disponível.</p>';
                    return;
                }
                profData.horarios.forEach(h => {
                    const btn = document.createElement('button');
                    btn.className = "slot-btn bg-white rounded-3xl py-5 text-md font-black text-gray-700 shadow-md hover-glow";
                    btn.innerText = h;
                    btn.onclick = () => {
                        selectedTime = h;
                        document.querySelectorAll('.slot-btn').forEach(b => b.classList.remove('slot-selected'));
                        btn.classList.add('slot-selected');
                        document.getElementById('section-finalizar').classList.remove('hidden');
                        document.getElementById('section-finalizar').scrollIntoView({behavior:'smooth'});
                        updateStepper(4);
                    };
                    container.appendChild(btn);
                });
                document.getElementById('section-horarios').scrollIntoView({behavior:'smooth'});
            } catch(e) {
                container.innerHTML = '<p class="col-span-full text-center text-erro text-lg">Erro na consulta premium.</p>';
            }
        }
        function mostrarErro(mensagem) {
            document.getElementById('msg-erro-texto').innerText = mensagem;
            document.getElementById('modal-erro').classList.remove('hidden');
        }
        function fecharModalErro() { document.getElementById('modal-erro').classList.add('hidden'); }
        async function finalizarReserva() {
            const nome = document.getElementById('cliente-nome').value;
            const fone = document.getElementById('cliente-whatsapp').value;
            if (!nome || fone.length < 14) return mostrarErro("Preencha seu nome e um telefone completo para prosseguir.");
            
            const btn = document.getElementById('btn-confirmar');
            btn.disabled = true;
            btn.innerText = "Processando Premium...";
            
            const siteKey = "{{ turnstile_site_key|default:'' }}";
            if (siteKey && typeof turnstile !== 'undefined' && turnstileWidgetId !== null) {
                try {
                    turnstile.execute(turnstileWidgetId);
                    return;
                } catch (e) { }
            }
            submitAgendamento(null);
        }
        async function submitAgendamento(token) {
            const nome = document.getElementById('cliente-nome').value;
            const fone = document.getElementById('cliente-whatsapp').value;
            const btn = document.getElementById('btn-confirmar');
            
            try {
                const res = await fetch(`${BASE_URL}/agendar`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        servico_id: selectedService,
                        profissional_id: selectedProfessional,
                        data: selectedDate,
                        horario: selectedTime,
                        nome_cliente: nome,
                        whatsapp: fone,
                        turnstile_token: token
                    })
                });
                const data = await res.json();
                if (res.ok) {
                    document.getElementById('modal-sucesso').classList.remove('hidden');
                    gerarVoucher(nome, fone, selectedDate, selectedTime, selectedServiceName, data.codigo);
                } else {
                    mostrarErro(data.message || "Erro no agendamento premium.");
                    btn.disabled = false;
                    btn.innerText = "Confirmar Agendamento Premium";
                }
            } catch(e) {
                mostrarErro("Erro de conexão premium.");
                btn.disabled = false;
                btn.innerText = "Confirmar Agendamento Premium";
            }
        }
        let turnstileWidgetId = null;
        function turnstileOnload() {
            try {
                const siteKey = "{{ turnstile_site_key|default:'' }}";
                if (!siteKey) return;
                turnstileWidgetId = turnstile.render('#turnstile-widget', {
                    sitekey: siteKey, size: 'invisible',
                    callback: submitAgendamento
                });
            } catch (e) {}
        }
        const phoneInput = document.getElementById('cliente-whatsapp');
        if (phoneInput) {
            phoneInput.addEventListener('input', function (e) {
                let v = e.target.value.replace(/\D/g, "");
                if (v.length > 11) v = v.substring(0, 11);
                if (v.length > 10) {
                    v = v.replace(/^(\d\d)(\d)(\d{4})(\d{4})/, "($1) $2 $3-$4");
                } else if (v.length > 5) {
                    v = v.replace(/^(\d\d)(\d{4})(\d{0,4})/, "($1) $2-$3");
                } else if (v.length > 2) {
                    v = v.replace(/^(\d\d)/, "($1) ");
                }
                e.target.value = v;
            });
        }
        function gerarVoucher(nome, tel, data, hora, servico, codigoBackend) {
            const safeNome = nome || "Cliente";
            const safeData = data ? data.split('-').reverse().join('/') : "--/--";
            const safeHora = hora || "--:--";
            const safeServico = servico || "Serviço";
            document.getElementById('v-nome').innerText = safeNome;
            document.getElementById('v-tel').innerText = tel;
            document.getElementById('v-data').innerText = safeData;
            document.getElementById('v-hora').innerText = safeHora;
            document.getElementById('v-servico').innerText = safeServico;
            new QRCode(document.getElementById("qrcode-voucher"), {
                text: codigoBackend || "PENDENTE",
                width: 128,
                height: 128,
                colorDark : "#000000",
                colorLight : "#ffffff",
                correctLevel : QRCode.CorrectLevel.H
            });
            setTimeout(() => {
                const elemento = document.getElementById('voucher-template');
                html2canvas(elemento, { scale: 3, backgroundColor: "#ffffff" }).then(canvas => {
                    const imgData = canvas.toDataURL("image/png");
                    document.getElementById('img-ticket-gerado').src = imgData;
                    document.getElementById('loading-ticket').classList.add('hidden');
                    document.getElementById('area-ticket-pronto').classList.remove('hidden');
                    const btnDown = document.getElementById('btn-download-ticket');
                    btnDown.href = imgData;
                    btnDown.download = `Voucher-Premium-${codigoBackend}.png`;
                });
            }, 500);
        }
    </script>
</body>
</html>
{% endblock %}