{% extends "base.html" %}
{% load static %}

{% block title %}Agendamento - {{ salao.nome }}{% endblock %}

{% block content %}

{# --- DADOS SEGUROS --- #}
{{ servicos|json_script:"SERVICOS_JSON" }}
{{ feriados|default:"[]"|json_script:"FERIADOS_JSON" }}
{{ folgas|default:"[]"|json_script:"FOLGAS_JSON" }}
{{ dias_fechados|default:"[]"|json_script:"DIAS_FECHADOS_JSON" }}

<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agendamento - {{ salao.nome }}</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    
    {% if turnstile_site_key %}
    <script src="https://challenges.cloudflare.com/turnstile/v0/api.js?onload=turnstileOnload" async defer></script>
    {% endif %}
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --cor-primaria: {{ salao.cor_tema|default:'#8E44AD' }};
            --cor-primaria-clara: color-mix(in srgb, var(--cor-primaria), white 90%);
        }
        
        .bg-theme-light { background-color: var(--cor-primaria-clara); }
        .text-theme { color: var(--cor-primaria); }
        .border-theme { border-color: var(--cor-primaria); }
        
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; color: #1f2937; margin: 0; padding: 0; }
        .gradient-bg { background: linear-gradient(135deg, var(--cor-primaria) 0%, var(--cor-primaria) 100%); }
        
        .selected-card { 
            border-color: var(--cor-primaria) !important; 
            background-color: var(--cor-primaria-clara); 
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); 
        }
        
        .slot-btn { border: 2px solid #f3f4f6; transition: all 0.2s; }
        .slot-btn:hover:not(:disabled) { border-color: var(--cor-primaria); color: var(--cor-primaria); transform: translateY(-2px); }
        .slot-selected { background-color: var(--cor-primaria) !important; color: white !important; border-color: var(--cor-primaria) !important; }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        .prof-img-container.selected-prof { border-color: var(--cor-primaria) !important; transform: scale(1.1); background-color: var(--cor-primaria-clara); }
        .cat-btn.active { background-color: var(--cor-primaria); color: white; border-color: var(--cor-primaria); }
        
        .calendar-day.disabled {
            opacity: 0.15 !important;
            cursor: not-allowed !important;
            pointer-events: none !important;
            background-color: #f3f4f6 !important;
            text-decoration: line-through;
        }
        .day-selected { background-color: var(--cor-primaria) !important; color: white !important; border-color: var(--cor-primaria) !important; }

        @keyframes modalPop { 0% { transform: scale(0.9); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        .animate-pop { animation: modalPop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
    </style>
</head>
<body>

    <div style="position: fixed; top: 0; left: 0; z-index: 0; pointer-events: none;">
        <div id="voucher-template" style="width: 380px; background: white; border-radius: 0 0 24px 0; overflow: hidden; font-family: 'Inter', sans-serif;">
            <div class="gradient-bg p-8 text-center text-white relative">
                <h2 class="text-xl font-extrabold uppercase tracking-wider mb-1">{{ salao.nome }}</h2>
                <p class="text-[10px] uppercase tracking-[0.2em] opacity-80">Comprovante Digital</p>
            </div>
            <div class="p-8 bg-white text-gray-800">
                <div class="text-center space-y-1 mb-6">
                    <p class="text-[10px] text-gray-400 uppercase font-bold tracking-wider">Cliente</p>
                    <p class="text-2xl font-black text-gray-900 leading-none" id="v-nome">Cliente</p>
                    <p class="text-xs text-gray-500 font-mono" id="v-tel">---</p>
                </div>
                <div class="border-t-2 border-dashed border-gray-100 my-6"></div>
                <div class="grid grid-cols-2 gap-4 text-center">
                    <div><p class="text-[10px] text-gray-400 uppercase font-bold tracking-wider">Data</p><p class="text-lg font-black text-theme" id="v-data">--/--</p></div>
                    <div><p class="text-[10px] text-gray-400 uppercase font-bold tracking-wider">Hor치rio</p><p class="text-lg font-black text-theme" id="v-hora">--:--</p></div>
                </div>
                <div class="text-center mt-6">
                    <p class="text-[10px] text-gray-400 uppercase font-bold tracking-wider">Servi칞o</p>
                    <p class="text-sm font-bold text-gray-800" id="v-servico">Servi칞o</p>
                </div>
                <div class="mt-8 flex flex-col items-center">
                    <div class="p-2 border border-gray-100 rounded-xl shadow-sm bg-white"><div id="v-qrcode"></div></div>
                </div>
            </div>
            <div class="h-2 gradient-bg"></div>
        </div>
    </div>

    <div id="main-wrapper" style="position: relative; z-index: 10; background-color: #f3f4f6; min-height: 100vh; width: 100%;">
        <div class="p-4 md:p-8">
            <div class="max-w-2xl mx-auto bg-white rounded-[3rem] shadow-2xl overflow-hidden pb-12">
                <div class="gradient-bg p-10 text-white text-center">
                    <h1 class="text-3xl font-extrabold tracking-tight uppercase">{{ salao.nome }}</h1>
                    <p class="opacity-90 mt-2 font-medium">Reserve o seu momento agora</p>
                </div>

                <div class="p-6 md:p-10 space-y-12">
                    
                    <section>
                        <div class="flex items-center space-x-3 mb-6">
                            <span class="bg-theme-light text-theme w-8 h-8 rounded-full flex items-center justify-center font-black italic">1</span>
                            <h3 class="text-gray-800 uppercase text-xs font-black tracking-widest">Escolha o Servi칞o</h3>
                        </div>

                        {% if categorias %}
                        <div class="mb-6 overflow-x-auto no-scrollbar py-2 -mx-2 px-2">
                            <div class="flex gap-2">
                                <button data-click="filtrarCategoria" data-id="todas" class="cat-btn active border border-gray-200 px-5 py-2.5 rounded-full text-sm font-bold text-gray-500 whitespace-nowrap hover:bg-gray-50">Todos</button>
                                {% for cat in categorias %}
                                <button data-click="filtrarCategoria" data-id="{{ cat.id }}" class="cat-btn border border-gray-200 px-5 py-2.5 rounded-full text-sm font-bold text-gray-500 whitespace-nowrap hover:bg-gray-50">{{ cat.nome }}</button>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}

                        <div class="grid grid-cols-1 gap-4" id="grid-servicos">
                            {% for servico in servicos %}
                            <label class="service-card relative flex items-center p-5 border-2 rounded-2xl cursor-pointer hover:border-gray-300 transition-all border-gray-100 shadow-sm animate-pop" data-cat="{{ servico.category_id|default:'sem-categoria' }}">
                                <input type="radio" name="service" value="{{ servico.id }}" class="hidden" data-change="selecionarServico">
                                <div class="flex-1">
                                    <span class="block font-bold text-lg text-gray-800">{{ servico.nome }}</span>
                                    <span class="text-xs text-gray-400 font-bold uppercase">{{ servico.duracao_minutos }} min</span>
                                </div>
                                {% if not salao.ocultar_precos %}<span class="font-black text-theme text-xl">R$ {{ servico.preco|floatformat:2 }}</span>{% endif %}
                            </label>
                            {% endfor %}
                        </div>
                        <div id="msg-sem-servico" class="hidden text-center text-gray-400 py-10 italic">Nenhum servi칞o nesta categoria.</div>
                    </section>

                    <section id="section-profissionais" class="opacity-40 pointer-events-none transition-all duration-500">
                        <div class="flex items-center space-x-3 mb-6">
                            <span class="bg-theme-light text-theme w-8 h-8 rounded-full flex items-center justify-center font-black italic">2</span>
                            <h3 class="text-gray-800 uppercase text-xs font-black tracking-widest">Com quem prefere?</h3>
                        </div>
                        <div id="lista-profissionais" class="flex space-x-6 overflow-x-auto no-scrollbar py-2">
                            <p class="text-gray-400 italic text-sm ml-2">Selecione o servi칞o acima...</p>
                        </div>
                    </section>

                    <section id="section-calendario" class="hidden transition-all duration-500">
                        <div class="flex items-center justify-between mb-6">
                            <div class="flex items-center space-x-3">
                                <span class="bg-theme-light text-theme w-8 h-8 rounded-full flex items-center justify-center font-black italic">3</span>
                                <h3 class="text-gray-800 uppercase text-xs font-black tracking-widest">Escolha a Data</h3>
                            </div>
                            <span id="label-mes-ano" class="text-sm font-bold text-theme bg-theme-light px-3 py-1 rounded-lg"></span>
                        </div>
                        <div class="bg-gray-50 p-6 rounded-[2rem] border-2 border-gray-100">
                            <div id="calendar-grid" class="grid grid-cols-7 gap-2 text-center text-sm"></div>
                        </div>
                    </section>

                    <section id="section-horarios" class="border-t border-gray-100 pt-10 hidden">
                        <div id="lista-horarios" class="grid grid-cols-3 sm:grid-cols-4 gap-3"></div>
                    </section>

                    <section id="section-finalizar" class="hidden border-t border-gray-200 pt-10">
                        <div class="bg-gray-50 p-8 rounded-[2.5rem] border-2 border-dashed border-gray-200">
                            <div class="space-y-4">
                                <input type="text" id="cliente-nome" placeholder="Seu nome completo" class="w-full p-5 rounded-2xl border-none font-bold shadow-sm outline-none focus:ring-2 focus:ring-purple-500 focus:ring-theme">
                                <input type="tel" id="cliente-whatsapp" maxlength="16" placeholder="(00) 0 0000-0000" class="w-full p-5 rounded-2xl border-none font-bold shadow-sm outline-none focus:ring-2 focus:ring-purple-500 focus:ring-theme">
                                <div id="turnstile-widget" class="hidden"></div>
                                <button data-click="finalizarReserva" id="btn-confirmar" class="w-full gradient-bg text-white font-black py-5 rounded-2xl shadow-xl transition-all mt-4 tracking-widest uppercase hover:opacity-90">Confirmar Agendamento</button>
                            </div>
                        </div>
                    </section>
                </div>
            </div>
        </div>
    </div>

    <div id="modal-sucesso" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-black/80 backdrop-blur-md transition-opacity"></div>
        <div class="relative bg-white rounded-3xl overflow-hidden shadow-2xl w-full max-w-sm transform animate-pop flex flex-col items-center z-50">
            <div class="w-full p-6 text-center bg-gray-50 border-b border-gray-100">
                <div class="w-16 h-16 rounded-full bg-green-100 flex items-center justify-center mx-auto mb-3">
                    <svg class="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg>
                </div>
                <h3 class="text-xl font-black text-gray-800">Agendamento Confirmado!</h3>
                <p class="text-xs text-gray-500 mt-1">Seu hor치rio foi reservado.</p>
            </div>
            <div id="loading-ticket" class="p-10 flex flex-col items-center">
                <div class="w-8 h-8 border-4 border-theme border-t-transparent rounded-full animate-spin"></div>
                <p class="text-xs text-gray-400 mt-3 font-bold uppercase tracking-widest">Gerando Ticket...</p>
            </div>
            <div id="area-ticket-pronto" class="hidden p-6 w-full flex justify-center bg-gray-100 border-b border-gray-100">
                <img id="img-ticket-gerado" class="rounded-xl shadow-lg w-[280px] h-auto border border-gray-200 block mx-auto" alt="Ticket">
            </div>
            <div id="erro-ticket" class="hidden p-6 text-center text-gray-400 text-xs italic">N칚o foi poss칤vel gerar a imagem do ticket.<br>Mas seu agendamento est치 confirmado!</div>
            <div class="p-6 w-full space-y-3 bg-white">
                <a id="btn-download-ticket" href="#" class="block w-full text-center gradient-bg text-white font-bold py-3.5 rounded-xl shadow-lg hover:opacity-90 transition-transform active:scale-95 flex items-center justify-center gap-2 cursor-pointer decoration-0">Baixar Comprovante</a>
                <button data-click="reloadPage" class="block w-full text-center text-gray-500 font-bold py-3 rounded-xl hover:bg-gray-50 transition">Novo Agendamento</button>
            </div>
        </div>
    </div>

    <div id="modal-erro" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm transition-opacity" data-click="fecharModalErro"></div>
        <div class="relative bg-white rounded-3xl overflow-hidden shadow-2xl w-full max-w-sm transform animate-pop z-50">
            <div class="h-3 bg-red-500 w-full"></div>
            <div class="p-8 text-center flex flex-col items-center gap-4">
                <h3 class="text-2xl font-black text-gray-800">Ops!</h3>
                <p id="msg-erro-texto" class="text-gray-500 font-medium leading-relaxed">Algo deu errado.</p>
                <button data-click="fecharModalErro" class="w-full bg-red-500 text-white font-bold py-4 rounded-xl shadow-lg shadow-red-200 mt-4 hover:bg-red-600 transition-colors active:scale-95">Tentar Novamente</button>
            </div>
        </div>
    </div>

    <script>
        // LEITURA SEGURA DE DADOS
        function getJsonData(id) {
            try {
                const el = document.getElementById(id);
                const data = el ? JSON.parse(el.textContent) : [];
                return data;
            } catch (e) {
                console.warn("Erro ao ler JSON:", id, e);
                return [];
            }
        }


        // Renderizar funcion치rios

        // Dentro da fun칞칚o renderizarProfissionais(lista)

lista.forEach(prof => {
    const div = document.createElement('div');
    div.className = "prof-card flex-shrink-0 text-center w-28 cursor-pointer group";
    
    // L칍GICA DE FOTO OU AVATAR
    let imgHtml = "";
    if (prof.foto_url) {
        imgHtml = `<img src="${prof.foto_url}" class="rounded-full w-full h-full object-cover">`;
    } else {
        imgHtml = `<img src="https://ui-avatars.com/api/?name=${encodeURIComponent(prof.nome)}&background=${THEME_HEX}&color=fff&bold=true" class="rounded-full w-full h-full">`;
    }

    div.innerHTML = `
        <div class="prof-img-container w-20 h-20 mx-auto rounded-full bg-white mb-3 border-4 border-gray-100 transition-all shadow-sm flex items-center justify-center overflow-hidden">
            ${imgHtml}
        </div>
        <span class="text-[10px] font-black uppercase text-gray-500">${prof.nome}</span>
    `;
    // ... (evento onclick mantido) ...
});


// Fim renderizar funcion치rios

        // --- DADOS DO BACKEND ---
        // For칞a Array vazio se falhar a leitura para evitar erro de .map
        const rawFeriados = getJsonData('FERIADOS_JSON');
        const FERIADOS = Array.isArray(rawFeriados) ? rawFeriados : [];
        
        const rawFolgas = getJsonData('FOLGAS_JSON');
        const FOLGAS = Array.isArray(rawFolgas) ? rawFolgas : [];
        
        const rawDias = getJsonData('DIAS_FECHADOS_JSON');
        const DIAS_FECHADOS = Array.isArray(rawDias) ? rawDias : [];
        
        const SERVICOS = getJsonData('SERVICOS_JSON');
        
        const SLUG = "{{ salao.slug }}";
        const BASE_URL = "/agendar/saloes/" + SLUG;
        const THEME_HEX = (getComputedStyle(document.documentElement).getPropertyValue('--cor-primaria').trim().replace('#','') || '8E44AD');

        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        document.addEventListener('click', (e) => {
            const el = e.target.closest('[data-click]');
            if(!el) return;
            const action = el.dataset.click;
            const arg = el.dataset.id || el; 
            if(typeof window[action] === 'function') window[action](arg);
        });

        document.addEventListener('change', (e) => {
            const el = e.target.closest('[data-change]');
            if(!el) return;
            const action = el.dataset.change;
            if(typeof window[action] === 'function') window[action](el);
        });

        let selectedService = null;
        let selectedServiceName = "Servi칞o";
        let selectedProfessional = null;
        let selectedDate = null;
        let selectedTime = null;

        function filtrarCategoria(btnOrId) {
            const btn = (btnOrId instanceof HTMLElement) ? btnOrId : document.querySelector(`.cat-btn[data-id="${btnOrId}"]`);
            if(!btn) return;
            const catId = btn.dataset.id;
            document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            const cards = document.querySelectorAll('.service-card');
            let visibleCount = 0;
            cards.forEach(card => {
                const cardCat = card.dataset.cat;
                if (catId === 'todas' || cardCat === catId) {
                    card.style.display = 'flex';
                    card.classList.remove('animate-pop');
                    void card.offsetWidth; 
                    card.classList.add('animate-pop');
                    visibleCount++;
                } else {
                    card.style.display = 'none';
                }
            });
            document.getElementById('msg-sem-servico').style.display = (visibleCount === 0) ? 'block' : 'none';
        }

        function mostrarErro(mensagem) {
            document.getElementById('msg-erro-texto').innerText = mensagem;
            document.getElementById('modal-erro').classList.remove('hidden');
        }
        function fecharModalErro() {
            document.getElementById('modal-erro').classList.add('hidden');
            if (selectedDate) buscarHorarios(selectedDate);
        }
        function reloadPage() { location.reload(); }

        let turnstileWidgetId = null;
        let pendingSubmit = false;

        function turnstileOnload() {
            try {
                const siteKey = "{{ turnstile_site_key|default:'' }}";
                if (!siteKey) return;
                turnstileWidgetId = turnstile.render('#turnstile-widget', {
                    sitekey: siteKey,
                    size: 'invisible',
                    callback: (token) => { pendingSubmit = false; submitAgendamento(token); },
                    'error-callback': () => {
                        pendingSubmit = false;
                        document.getElementById('btn-confirmar').disabled = false;
                        mostrarErro("N칚o foi poss칤vel validar a seguran칞a (anti-bot).");
                    }
                });
            } catch (e) {}
        }

        // --- PREPARA칂츾O SEGURA DOS BLOQUEIOS ---
        // Garante que o c칩digo n칚o quebre se FERIADOS vier vazio
        let bloqueios = {
            feriados: FERIADOS.map(f => f.data || f), 
            dias_recorrentes: DIAS_FECHADOS
        };

        const phoneInput = document.getElementById('cliente-whatsapp');
        if(phoneInput) {
            phoneInput.addEventListener('input', function (e) {
                let v = e.target.value.replace(/\D/g, "");
                if (v.length > 11) v = v.substring(0, 11);
                
                let formatted = v;
                if (v.length > 10) { 
                    formatted = `(${v.substring(0,2)}) ${v.substring(2,3)} ${v.substring(3,7)}-${v.substring(7)}`;
                } else if (v.length > 6) {
                    formatted = `(${v.substring(0,2)}) ${v.substring(2,6)}-${v.substring(6)}`;
                } else if (v.length > 2) {
                    formatted = `(${v.substring(0,2)}) ${v.substring(2)}`;
                } else if (v.length > 0) {
                    formatted = `(${v}`;
                }
                e.target.value = formatted;
            });
        }

        async function selecionarServico(input) {
            selectedService = input.value;
            selectedServiceName = input.closest('.service-card').querySelector('span.block').innerText;
            document.querySelectorAll('.service-card').forEach(card => card.classList.remove('selected-card'));
            input.parentElement.classList.add('selected-card');

            document.getElementById('section-profissionais').classList.remove('opacity-40', 'pointer-events-none');
            const container = document.getElementById('lista-profissionais');
            container.innerHTML = '<p class="text-theme font-bold loading-text ml-2 text-sm">游댌 Buscando especialistas...</p>';

            try {
                const res = await fetch(`${BASE_URL}/profissionais-por-servico/${selectedService}`);
                const profs = await res.json();
                
                container.innerHTML = '';
                if(profs.length === 0) {
                    container.innerHTML = '<p class="text-orange-500 font-bold text-sm ml-2">Nenhum profissional habilitado.</p>';
                    return;
                }
                
                profs.forEach(p => {
                    const div = document.createElement('div');
                    div.className = "prof-card flex-shrink-0 text-center w-28 cursor-pointer group";
                    div.innerHTML = `
                        <div class="prof-img-container w-20 h-20 mx-auto rounded-full bg-white mb-3 border-4 border-gray-100 transition-all shadow-sm flex items-center justify-center">
                            <img src="https://ui-avatars.com/api/?name=${encodeURIComponent(p.nome)}&background=${THEME_HEX}&color=fff&bold=true" class="rounded-full w-full h-full">
                        </div>
                        <span class="text-[10px] font-black uppercase text-gray-500">${p.nome}</span>
                    `;
                    div.onclick = () => {
                        selectedProfessional = p.id;
                        document.querySelectorAll('.prof-img-container').forEach(c => c.classList.remove('selected-prof', 'border-theme'));
                        div.querySelector('.prof-img-container').classList.add('selected-prof', 'border-theme');
                        document.getElementById('section-calendario').classList.remove('hidden');
                        renderizarCalendario();
                        document.getElementById('section-calendario').scrollIntoView({behavior:'smooth'});
                    };
                    container.appendChild(div);
                });
                document.getElementById('section-profissionais').scrollIntoView({behavior:'smooth', block: 'center'});
            } catch(e) {
                container.innerHTML = '<p class="text-red-500 text-sm">Erro ao carregar profissionais.</p>';
            }
        }

        function renderizarCalendario() {
            try {
                const grid = document.getElementById('calendar-grid');
                grid.innerHTML = '';
                
                const diasS = ['D', 'S', 'T', 'Q', 'Q', 'S', 'S'];
                diasS.forEach(d => {
                    const el = document.createElement('div');
                    el.className = "font-black text-gray-300 text-[10px] pb-2";
                    el.innerText = d;
                    grid.appendChild(el);
                });

                const hoje = new Date();
                hoje.setHours(0,0,0,0);
                
                const meses = ["Janeiro", "Fevereiro", "Mar칞o", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
                const mesesCurto = ["Jan", "Fev", "Mar", "Abr", "Mai", "Jun", "Jul", "Ago", "Set", "Out", "Nov", "Dez"];
                
                const dataFinal = new Date(hoje);
                dataFinal.setDate(hoje.getDate() + 30);
                
                const mesInicial = meses[hoje.getMonth()];
                const mesFinal = meses[dataFinal.getMonth()];
                
                let textoHeader = `${mesInicial} ${hoje.getFullYear()}`;
                if (mesInicial !== mesFinal) {
                    textoHeader = `${mesInicial.substring(0,3)} - ${mesFinal.substring(0,3)} ${dataFinal.getFullYear()}`;
                }
                document.getElementById('label-mes-ano').innerText = textoHeader;

                const primeiroDiaExibido = new Date(hoje);
                const deslocamento = primeiroDiaExibido.getDay(); // 0 = Dom
                for (let j = 0; j < deslocamento; j++) { 
                    grid.appendChild(document.createElement('div')); 
                }

                for (let i = 0; i < 30; i++) {
                    const data = new Date(hoje.getTime());
                    data.setDate(hoje.getDate() + i);
                    
                    const iso = data.getFullYear() + '-' + String(data.getMonth() + 1).padStart(2, '0') + '-' + String(data.getDate()).padStart(2, '0');
                    const jsDay = data.getDay(); // 0=Dom
                    const mapDia = { 0: 6, 1: 0, 2: 1, 3: 2, 4: 3, 5: 4, 6: 5 };
                    const pythonDay = mapDia[jsDay];

                    // Uso seguro da vari치vel global bloqueios
                    const ehFeriado = bloqueios.feriados.includes(iso);
                    const ehDiaFechado = bloqueios.dias_recorrentes.includes(pythonDay);
                    const estaBloqueado = ehFeriado || ehDiaFechado;

                    const btn = document.createElement('button');
                    
                    if (data.getDate() === 1 || i === 0) {
                         btn.innerHTML = `${data.getDate()} <br><span class="text-[9px] uppercase">${mesesCurto[data.getMonth()]}</span>`;
                         btn.classList.add("leading-none");
                    } else {
                        btn.innerText = data.getDate();
                    }

                    btn.className = `p-3 rounded-xl font-bold transition-all flex flex-col items-center justify-center h-12 ${estaBloqueado ? 'calendar-day disabled' : 'bg-white text-gray-700 hover:bg-theme-light shadow-sm border border-gray-100'}`;

                    if(!estaBloqueado) {
                        btn.onclick = () => {
                            selectedDate = iso;
                            document.querySelectorAll('#calendar-grid button').forEach(b => b.classList.remove('day-selected'));
                            btn.classList.add('day-selected');
                            buscarHorarios(iso);
                        };
                    } else {
                        btn.disabled = true;
                    }
                    grid.appendChild(btn);
                }
            } catch(e) {
                console.error("Erro renderizarCalendario:", e);
                document.getElementById('calendar-grid').innerHTML = '<p class="col-span-7 text-center text-red-400 text-xs">Erro ao desenhar calend치rio.</p>';
            }
        }

        async function buscarHorarios(iso) {
            const container = document.getElementById('lista-horarios');
            document.getElementById('section-horarios').classList.remove('hidden');
            container.innerHTML = '<p class="col-span-full text-center text-theme font-bold p-4">Consultando hor치rios...</p>';
            
            try {
                const res = await fetch(`${BASE_URL}/disponibilidade/${iso}?service_id=${selectedService}&professional_id=${selectedProfessional}`);
                const data = await res.json();
                
                const profData = data.find(p => p.professional_id == selectedProfessional);
                
                container.innerHTML = '';
                if (!profData || !profData.horarios || profData.horarios.length === 0) {
                    container.innerHTML = '<p class="col-span-full text-center text-gray-400 font-bold p-4 bg-gray-50 rounded-2xl italic">Nenhum hor치rio dispon칤vel.</p>';
                    return;
                }
                
                profData.horarios.forEach(h => {
                    const btn = document.createElement('button');
                    btn.className = "slot-btn bg-white rounded-2xl py-4 text-sm font-black text-gray-700 shadow-sm";
                    btn.innerText = h;
                    btn.onclick = () => {
                        selectedTime = h;
                        document.querySelectorAll('.slot-btn').forEach(b => b.classList.remove('slot-selected'));
                        btn.classList.add('slot-selected');
                        document.getElementById('section-finalizar').classList.remove('hidden');
                        document.getElementById('section-finalizar').scrollIntoView({behavior:'smooth'});
                    };
                    container.appendChild(btn);
                });
                document.getElementById('section-horarios').scrollIntoView({behavior:'smooth'});
            } catch(e) {
                container.innerHTML = '<p class="col-span-full text-center text-red-400">Erro na consulta.</p>';
            }
        }

        async function finalizarReserva() {
            const nome = document.getElementById('cliente-nome').value;
            const fone = document.getElementById('cliente-whatsapp').value;
            
            if (!nome || fone.length < 14) return mostrarErro("Preencha seu nome e um telefone completo.");

            const btn = document.getElementById('btn-confirmar');
            btn.disabled = true;
            btn.innerText = "Processando...";
            
            const siteKey = "{{ turnstile_site_key|default:'' }}";
            if (siteKey && typeof turnstile !== 'undefined' && turnstileWidgetId !== null) {
                try {
                    pendingSubmit = true;
                    btn.innerText = "Verificando...";
                    turnstile.execute(turnstileWidgetId);
                    return;
                } catch (e) { }
            }
            return submitAgendamento(null);
        }

        async function submitAgendamento(turnstileToken) {
            const nome = document.getElementById('cliente-nome').value;
            const fone = document.getElementById('cliente-whatsapp').value;
            const btn = document.getElementById('btn-confirmar');
            const originalText = "Confirmar Agendamento";

            try {
                const res = await fetch(`${BASE_URL}/agendar`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify({
                        servico_id: selectedService,
                        profissional_id: selectedProfessional,
                        data: selectedDate,
                        horario: selectedTime,
                        nome_cliente: nome,
                        whatsapp: fone,
                        turnstile_token: turnstileToken
                    })
                });

                if (res.ok) {
                    document.getElementById('modal-sucesso').classList.remove('hidden');
                    try {
                        gerarVoucher(nome, fone, selectedDate, selectedTime, selectedServiceName);
                    } catch(err) {
                        document.getElementById('loading-ticket').classList.add('hidden');
                        document.getElementById('erro-ticket').classList.remove('hidden');
                    }
                } else {
                    let msg = "Erro ao agendar.";
                    try { const j = await res.json(); if(j.message) msg = j.message; } catch(e){}
                    mostrarErro(msg);
                    btn.disabled = false;
                    btn.innerText = originalText;
                }
            } catch (e) {
                mostrarErro("Erro de conex칚o.");
                btn.disabled = false;
                btn.innerText = originalText;
            }
        }

        function gerarVoucher(nome, tel, data, hora, servico) {
            const safeNome = nome || "Cliente";
            const safeData = data ? data.split('-').reverse().join('/') : "--/--";
            const safeHora = hora || "--:--";
            const safeServico = servico || "Servi칞o";

            document.getElementById('v-nome').innerText = safeNome;
            document.getElementById('v-tel').innerText = tel;
            document.getElementById('v-data').innerText = safeData;
            document.getElementById('v-hora').innerText = safeHora;
            document.getElementById('v-servico').innerText = safeServico;
            
            const qrContainer = document.getElementById('v-qrcode');
            qrContainer.innerHTML = ""; 
            
            new QRCode(qrContainer, {
                text: `${safeNome}|${safeData}|${safeHora}|${safeServico}`,
                width: 128, height: 128,
                colorDark : "{{ salao.cor_tema|default:'#334155' }}",
                colorLight : "#ffffff",
                correctLevel : QRCode.CorrectLevel.L
            });

            setTimeout(() => {
                const elemento = document.getElementById('voucher-template');
                html2canvas(elemento, { scale: 2, backgroundColor: "#ffffff" }).then(canvas => {
                    const imgData = canvas.toDataURL("image/png");
                    document.getElementById('img-ticket-gerado').src = imgData;
                    document.getElementById('loading-ticket').classList.add('hidden');
                    document.getElementById('area-ticket-pronto').classList.remove('hidden');
                    const btnDown = document.getElementById('btn-download-ticket');
                    btnDown.href = imgData;
                    btnDown.download = `Voucher.png`;
                });
            }, 800);
        }
    </script>
</body>
</html>
{% endblock %}