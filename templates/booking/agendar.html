{% extends "base.html" %}
{% load static %}

{% block title %}Agendamento - {{ salao.nome }}{% endblock %}

{% block content %}

{{ servicos|json_script:"SERVICOS_JSON" }}
{{ profissionais|json_script:"PROFISSIONAIS_JSON" }} 
{{ feriados|default:"[]"|json_script:"FERIADOS_JSON" }}
{{ folgas|default:"[]"|json_script:"FOLGAS_JSON" }}
{{ dias_fechados|default:"[]"|json_script:"DIAS_FECHADOS_JSON" }}

<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agendamento - {{ salao.nome }}</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    
    {% if turnstile_site_key %}
    <script src="https://challenges.cloudflare.com/turnstile/v0/api.js?onload=turnstileOnload" async defer></script>
    {% endif %}
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --cor-primaria: {{ salao.cor_tema|default:'#8E44AD' }};
            --cor-primaria-clara: color-mix(in srgb, var(--cor-primaria), white 90%);
        }
        .bg-theme-light { background-color: var(--cor-primaria-clara); }
        .text-theme { color: var(--cor-primaria); }
        .border-theme { border-color: var(--cor-primaria); }
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; color: #1f2937; margin: 0; padding: 0; }
        .gradient-bg { background: linear-gradient(135deg, var(--cor-primaria) 0%, var(--cor-primaria) 100%); }
        .selected-card { border-color: var(--cor-primaria) !important; background-color: var(--cor-primaria-clara); box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); }
        .slot-btn { border: 2px solid #f3f4f6; transition: all 0.2s; }
        .slot-btn:hover:not(:disabled) { border-color: var(--cor-primaria); color: var(--cor-primaria); transform: translateY(-2px); }
        .slot-selected { background-color: var(--cor-primaria) !important; color: white !important; border-color: var(--cor-primaria) !important; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .prof-img-container.selected-prof { border-color: var(--cor-primaria) !important; background-color: var(--cor-primaria-clara); }
        .cat-btn.active { background-color: var(--cor-primaria); color: white; border-color: var(--cor-primaria); }
        .calendar-day.disabled { opacity: 0.3 !important; cursor: not-allowed !important; pointer-events: none !important; background-color: #e5e7eb !important; text-decoration: line-through; color: #9ca3af !important; }
        .day-selected { background-color: var(--cor-primaria) !important; color: white !important; border-color: var(--cor-primaria) !important; }
        @keyframes modalPop { 0% { transform: scale(0.9); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        .animate-pop { animation: modalPop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
    </style>
</head>
<body>

    <div style="position: fixed; top: 0; left: 0; z-index: 0; pointer-events: none; opacity: 0;">
        <div id="voucher-template" style="width: 380px; background: white; border-radius: 0 0 24px 0; overflow: hidden; font-family: 'Inter', sans-serif;">
            
            <div class="gradient-bg p-6 text-center text-white relative">
                <h2 class="text-xl font-extrabold uppercase tracking-wider mb-1">{{ salao.nome }}</h2>
                <p class="text-[10px] uppercase tracking-[0.2em] opacity-80">Comprovante Digital</p>
            </div>

            <div class="p-8 bg-white text-gray-800 pb-6">
                <div class="text-center space-y-1 mb-6">
                    <p class="text-[10px] text-gray-400 uppercase font-bold tracking-wider">Cliente</p>
                    <p class="text-2xl font-black text-gray-900 leading-none" id="v-nome">Cliente</p>
                    <p class="text-xs text-gray-500 font-mono" id="v-tel">---</p>
                </div>
                
                <div class="border-t-2 border-dashed border-gray-100 my-6"></div>
                
                <div class="grid grid-cols-2 gap-4 text-center">
                    <div><p class="text-[10px] text-gray-400 uppercase font-bold tracking-wider">Data</p><p class="text-lg font-black text-theme" id="v-data">--/--</p></div>
                    <div><p class="text-[10px] text-gray-400 uppercase font-bold tracking-wider">Horário</p><p class="text-lg font-black text-theme" id="v-hora">--:--</p></div>
                </div>
                
                <div class="text-center mt-6">
                    <p class="text-[10px] text-gray-400 uppercase font-bold tracking-wider">Serviço</p>
                    <p class="text-sm font-bold text-gray-800" id="v-servico">Serviço</p>
                </div>
                
                <div class="mt-8 flex flex-col items-center">
                    <p class="text-[10px] text-gray-400 uppercase font-bold tracking-wider mb-2">Código de Validação</p>
                    <div class="bg-gray-100 px-8 py-3 rounded-xl border-2 border-dashed border-gray-200">
                        <p id="v-codigo" class="text-2xl font-mono font-black text-gray-700 tracking-[0.2em]"></p>
                    </div>
                </div>
            </div>

            <div class="bg-gray-50 px-6 py-5 border-t border-gray-100 text-center space-y-3">
                
                {% if salao.telefone %}
                <p class="text-xs font-bold text-gray-700 flex items-center justify-center gap-1">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-3 h-3 text-theme" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/></svg>
                    {{ salao.telefone }}
                </p>
                {% endif %}

                {% if endereco %}
                <div class="text-[10px] text-gray-500 leading-tight">
                    <p class="font-semibold text-gray-600 mb-0.5">Localização:</p>
                    <p>
                        {% if endereco.logradouro %}{{ endereco.logradouro }}{% endif %}
                        {% if endereco.numero %}, {{ endereco.numero }}{% endif %}
                        {% if endereco.complemento %} - {{ endereco.complemento }}{% endif %}
                    </p>
                    <p>
                        {% if endereco.bairro %}{{ endereco.bairro }}{% endif %}
                        {% if endereco.cidade %} - {{ endereco.cidade }}{% endif %}
                    </p>
                </div>
                {% endif %}
            </div>

            <div class="h-2 gradient-bg"></div>
        </div>
    </div>

    <div id="main-wrapper" style="position: relative; z-index: 10; background-color: #f3f4f6; min-height: 100vh; width: 100%;">
        <div class="p-4 md:p-8">
            <div class="max-w-2xl mx-auto bg-white rounded-[3rem] shadow-2xl overflow-hidden pb-12">
                <div class="gradient-bg p-10 text-white text-center">
                    <h1 class="text-3xl font-extrabold tracking-tight uppercase">{{ salao.nome }}</h1>
                    <p class="opacity-90 mt-2 font-medium">Reserve o seu momento agora</p>
                </div>

                <div class="p-6 md:p-10 space-y-12">
                    <section>
                        <div class="flex items-center space-x-3 mb-6">
                            <span class="bg-theme-light text-theme w-8 h-8 rounded-full flex items-center justify-center font-black italic">1</span>
                            <h3 class="text-gray-800 uppercase text-xs font-black tracking-widest">Escolha o Serviço</h3>
                        </div>

                        {% if categorias %}
                        <div class="mb-6 overflow-x-auto no-scrollbar py-2 -mx-2 px-2">
                            <div class="flex gap-2">
                                {# BOTÃO TODOS REMOVIDO #}
                                {% for cat in categorias %}
                                <button onclick="filtrarCategoria(this)" data-id="{{ cat.id }}" class="cat-btn border border-gray-200 px-5 py-2.5 rounded-full text-sm font-bold text-gray-500 whitespace-nowrap hover:bg-gray-50">{{ cat.nome }}</button>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}

                        <div class="grid grid-cols-1 gap-4" id="grid-servicos">
                            {% for servico in servicos %}
                            <div class="service-card relative flex items-center p-5 border-2 rounded-2xl cursor-pointer hover:border-gray-300 transition-all border-gray-100 shadow-sm animate-pop" 
                                 data-cat="{{ servico.category_id|default:'sem-categoria' }}"
                                 onclick="selecionarServico('{{ servico.id }}', '{{ servico.nome }}', this)">
                                <div class="flex-1">
                                    <span class="block font-bold text-lg text-gray-800">{{ servico.nome }}</span>
                                    <span class="text-xs text-gray-400 font-bold uppercase">{{ servico.duracao_minutos }} min</span>
                                </div>
                                {% if not salao.ocultar_precos %}<span class="font-black text-theme text-xl">R$ {{ servico.preco|floatformat:2 }}</span>{% endif %}
                            </div>
                            {% endfor %}
                        </div>
                        <div id="msg-sem-servico" class="hidden text-center text-gray-400 py-10 italic">Nenhum serviço nesta categoria.</div>
                    </section>

                    <section id="section-profissionais" class="hidden transition-all duration-500"></section>
                        <div class="flex items-center space-x-3 mb-6">
                            <span class="bg-theme-light text-theme w-8 h-8 rounded-full flex items-center justify-center font-black italic">2</span>
                            <h3 class="text-gray-800 uppercase text-xs font-black tracking-widest">Com quem prefere?</h3>
                        </div>
                        <div id="lista-profissionais" class="flex space-x-6 overflow-x-auto no-scrollbar py-2">
                            <p class="text-gray-400 italic text-sm ml-2">Selecione o serviço acima...</p>
                        </div>
                    </section>

                    <section id="section-calendario" class="hidden transition-all duration-500">
                        <div class="flex items-center justify-between mb-6">
                            <div class="flex items-center space-x-3">
                                <span class="bg-theme-light text-theme w-8 h-8 rounded-full flex items-center justify-center font-black italic">3</span>
                                <h3 class="text-gray-800 uppercase text-xs font-black tracking-widest">Escolha a Data</h3>
                            </div>
                            <span id="label-mes-ano" class="text-sm font-bold text-theme bg-theme-light px-3 py-1 rounded-lg"></span>
                        </div>
                        <div class="bg-gray-50 p-6 rounded-[2rem] border-2 border-gray-100">
                            <div id="calendar-grid" class="grid grid-cols-7 gap-2 text-center text-sm"></div>
                        </div>
                    </section>

                    <section id="section-horarios" class="border-t border-gray-100 pt-10 hidden">
                        <div id="lista-horarios" class="grid grid-cols-3 sm:grid-cols-4 gap-3"></div>
                    </section>

                    <section id="section-finalizar" class="hidden border-t border-gray-200 pt-10">
                        <div class="bg-gray-50 p-8 rounded-[2.5rem] border-2 border-dashed border-gray-200">
                            <div class="space-y-4">
                                <input type="text" id="cliente-nome" placeholder="Seu nome completo" class="w-full p-5 rounded-2xl border-none font-bold shadow-sm outline-none focus:ring-2 focus:ring-purple-500 focus:ring-theme">
                                <input type="tel" id="cliente-whatsapp" maxlength="16" placeholder="(00) 0 0000-0000" class="w-full p-5 rounded-2xl border-none font-bold shadow-sm outline-none focus:ring-2 focus:ring-purple-500 focus:ring-theme">
                                <div id="turnstile-widget" class="hidden"></div>
                                <button onclick="finalizarReserva()" id="btn-confirmar" class="w-full gradient-bg text-white font-black py-5 rounded-2xl shadow-xl transition-all mt-4 tracking-widest uppercase hover:opacity-90">Confirmar Agendamento</button>
                            </div>
                        </div>
                    </section>
                </div>
            </div>
        </div>
    </div>

    <div id="modal-sucesso" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-black/80 backdrop-blur-md transition-opacity"></div>
        <div class="relative bg-white rounded-3xl overflow-hidden shadow-2xl w-full max-w-sm transform animate-pop flex flex-col items-center z-50">
            <div class="w-full p-6 text-center bg-gray-50 border-b border-gray-100">
                <div class="w-16 h-16 rounded-full bg-green-100 flex items-center justify-center mx-auto mb-3">
                    <svg class="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg>
                </div>
                <h3 class="text-xl font-black text-gray-800">Agendamento Confirmado!</h3>
                <p class="text-xs text-gray-500 mt-1">Seu horário foi reservado.</p>
            </div>
            <div id="loading-ticket" class="p-10 flex flex-col items-center">
                <div class="w-8 h-8 border-4 border-theme border-t-transparent rounded-full animate-spin"></div>
                <p class="text-xs text-gray-400 mt-3 font-bold uppercase tracking-widest">Gerando Ticket...</p>
            </div>
            <div id="area-ticket-pronto" class="hidden p-6 w-full flex justify-center bg-gray-100 border-b border-gray-100">
                <img id="img-ticket-gerado" class="rounded-xl shadow-lg w-[280px] h-auto border border-gray-200 block mx-auto" alt="Ticket">
            </div>
            <div class="p-6 w-full space-y-3 bg-white">
                <a id="btn-download-ticket" href="#" class="block w-full text-center gradient-bg text-white font-bold py-3.5 rounded-xl shadow-lg hover:opacity-90 transition-transform active:scale-95 flex items-center justify-center gap-2 cursor-pointer decoration-0">Baixar Comprovante</a>
                <button onclick="location.reload()" class="block w-full text-center text-gray-500 font-bold py-3 rounded-xl hover:bg-gray-50 transition">Novo Agendamento</button>
            </div>
        </div>
    </div>

    <div id="modal-erro" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm transition-opacity" onclick="fecharModalErro()"></div>
        <div class="relative bg-white rounded-3xl overflow-hidden shadow-2xl w-full max-w-sm transform animate-pop z-50">
            <div class="h-3 bg-red-500 w-full"></div>
            <div class="p-8 text-center flex flex-col items-center gap-4">
                <h3 class="text-2xl font-black text-gray-800">Ops!</h3>
                <p id="msg-erro-texto" class="text-gray-500 font-medium leading-relaxed">Algo deu errado.</p>
                <button onclick="fecharModalErro()" class="w-full bg-red-500 text-white font-bold py-4 rounded-xl shadow-lg shadow-red-200 mt-4 hover:bg-red-600 transition-colors active:scale-95">Tentar Novamente</button>
            </div>
        </div>
    </div>

    <script>
        function getJsonData(id) {
            try {
                const el = document.getElementById(id);
                return el ? JSON.parse(el.textContent) : [];
            } catch (e) { return []; }
        }

        const SERVICOS = getJsonData('SERVICOS_JSON');
        const PROFISSIONAIS_ALL = getJsonData('PROFISSIONAIS_JSON'); 
        const rawFeriados = getJsonData('FERIADOS_JSON');
        const FERIADOS = Array.isArray(rawFeriados) ? rawFeriados : [];
        const rawFolgas = getJsonData('FOLGAS_JSON');
        const FOLGAS = Array.isArray(rawFolgas) ? rawFolgas : [];
        const rawDias = getJsonData('DIAS_FECHADOS_JSON');
        const DIAS_FECHADOS = Array.isArray(rawDias) ? rawDias : [];
        
        const SLUG = "{{ salao.slug }}";
        const BASE_URL = "/agendar/saloes/" + SLUG;
        const THEME_HEX = (getComputedStyle(document.documentElement).getPropertyValue('--cor-primaria').trim().replace('#','') || '8E44AD');

        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        let selectedService = null;
        let selectedServiceName = "Serviço";
        let selectedProfessional = null;
        let selectedDate = null;
        let selectedTime = null;
        let mesAtual = new Date();

        window.addEventListener('DOMContentLoaded', () => {
            const firstCatBtn = document.querySelector('.cat-btn');
            if(firstCatBtn) filtrarCategoria(firstCatBtn);
        });




function filtrarCategoria(btn) {
    if(!btn) return;
    
    // 1. Resetar o estado (Limpa serviço, profissional, data e hora selecionados)
    resetarEstado(1); 
    
    // 2. Visual dos botões de categoria
    document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    
    // 3. Filtrar os cards de serviço
    const catId = btn.dataset.id;
    const cards = document.querySelectorAll('.service-card');
    let visibleCount = 0;

    cards.forEach(card => {
        // Comparamos o data-cat do HTML com o data-id do botão clicado
        if (card.dataset.cat === catId) {
            card.style.display = 'flex'; // Mostra o serviço da categoria
            visibleCount++;
            
            // Força o reinício da animação pop
            card.classList.remove('animate-pop');
            void card.offsetWidth; 
            card.classList.add('animate-pop');
        } else {
            card.style.display = 'none'; // Esconde serviços de outras categorias
        }
    });

    // 4. Feedback se a categoria estiver vazia
    document.getElementById('msg-sem-servico').style.display = (visibleCount === 0) ? 'block' : 'none';
    
    // 5. Garante que as seções seguintes comecem escondidas
    document.getElementById('section-profissionais').classList.add('hidden');
}



        // 1. RESETAR (Mantenha apenas ESTA versão no topo)
function resetarEstado(nivel) {
    // Nível 1 ou 2: Mudou categoria ou serviço (Limpa tudo dali para baixo)
    if (nivel <= 2) {
        selectedProfessional = null;
        selectedDate = null;
        selectedTime = null;

        // 1. LIMPA O CONTEÚDO DOS PROFISSIONAIS
        const listaProf = document.getElementById('lista-profissionais');
        if (listaProf) {
            // Voltamos ao texto inicial ou deixamos vazio
            listaProf.innerHTML = '<p class="text-gray-400 italic text-sm ml-2">Selecione o serviço acima...</p>';
        }

        // 2. ESCONDE AS SEÇÕES (Volta ao estado inicial do layout)
        document.getElementById('section-profissionais').classList.add('hidden');
        document.getElementById('section-calendario').classList.add('hidden');
        document.getElementById('section-horarios').classList.add('hidden');
        document.getElementById('section-finalizar').classList.add('hidden');
        
        // 3. LIMPA OUTROS DADOS VISUAIS
        document.getElementById('lista-horarios').innerHTML = '';
        document.querySelectorAll('.prof-img-container').forEach(c => 
            c.classList.remove('selected-prof', 'border-theme', 'scale-110')
        );
    }

    // Nível 3: Mudou apenas o profissional (Limpa apenas data e horário)
    if (nivel === 3) {
        selectedDate = null;
        selectedTime = null;
        document.getElementById('section-horarios').classList.add('hidden');
        document.getElementById('section-finalizar').classList.add('hidden');
        document.getElementById('lista-horarios').innerHTML = '';
        if (typeof renderizarCalendario === "function") renderizarCalendario();
    }
}

// 2. SELECIONAR SERVIÇO (Melhorado para carregar profissionais na hora)
function selecionarServico(id, nome, cardEl) {
    // Limpa tudo o que foi selecionado depois do serviço
    resetarEstado(2);
    
    selectedService = id;
    selectedServiceName = nome;
    
    document.querySelectorAll('.service-card').forEach(c => c.classList.remove('selected-card'));
    cardEl.classList.add('selected-card');

    // Agora populamos a lista de profissionais SOMENTE com quem faz este serviço
    const container = document.getElementById('lista-profissionais');
    container.innerHTML = '';
    
    const profsFiltrados = PROFISSIONAIS_ALL.filter(p => p.servicos.includes(parseInt(id)));

    if (profsFiltrados.length === 0) {
        container.innerHTML = '<p class="text-orange-500 font-bold text-sm ml-2">Nenhum profissional disponível para este serviço.</p>';
    } else {
        profsFiltrados.forEach(p => {
            const div = document.createElement('div');
            div.className = "prof-card flex-shrink-0 text-center w-28 cursor-pointer group"; 
            let imgHtml = p.foto 
                ? `<img src="${p.foto}" class="rounded-full w-full h-full object-cover">`
                : `<img src="https://ui-avatars.com/api/?name=${encodeURIComponent(p.nome)}&background=${THEME_HEX}&color=fff&bold=true" class="rounded-full w-full h-full">`;

            div.innerHTML = `
                <div class="prof-img-container w-24 h-24 mx-auto translate-x-4 rounded-full bg-white mb-3 border-4 border-gray-100 transition-all shadow-sm flex items-center justify-center overflow-hidden" data-pid="${p.id}">
                    ${imgHtml}
                </div>
                <span class="block text-[10px] font-black uppercase text-gray-500 translate-x-4">${p.nome}</span>
            `;
            // Ao clicar no profissional, resetamos o nível 3 (data/hora) e seguimos
            div.onclick = () => {
                selecionarProfissionalUI(p.id, div);
            };
            container.appendChild(div);
        });
    }

    // Mostra a seção de profissionais e rola a tela
    const sectionProf = document.getElementById('section-profissionais');
    sectionProf.classList.remove('hidden');
    sectionProf.scrollIntoView({behavior:'smooth', block: 'center'});
}

// 3. SELECIONAR PROFISSIONAL
function selecionarProfissionalUI(pid, divEl) {
    resetarEstado(3); // Limpa data e hora se ele trocar de profissional
    selectedProfessional = pid;
    
    document.querySelectorAll('.prof-img-container').forEach(c => c.classList.remove('selected-prof', 'border-theme', 'scale-110'));
    divEl.querySelector('.prof-img-container').classList.add('selected-prof', 'border-theme', 'scale-110');
    
    document.getElementById('section-calendario').classList.remove('hidden');
    renderizarCalendario();
    document.getElementById('section-calendario').scrollIntoView({behavior:'smooth'});
}
        // 5. CALENDÁRIO COM VISUAL BLOQUEADO
        function renderizarCalendario() {
            try {
                const grid = document.getElementById('calendar-grid');
                grid.innerHTML = '';
                
                const diasS = ['D', 'S', 'T', 'Q', 'Q', 'S', 'S'];
                diasS.forEach(d => grid.innerHTML += `<div class="font-black text-gray-300 text-[10px] pb-2">${d}</div>`);

                const hoje = new Date();
                hoje.setHours(0,0,0,0);
                const ano = mesAtual.getFullYear();
                const mes = mesAtual.getMonth();
                const meses = ["Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
                
                document.getElementById('label-mes-ano').innerHTML = `
                    <button onclick="mudarMes(-1)" class="px-2 text-lg hover:text-theme">‹</button>
                    <span class="mx-2">${meses[mes]} ${ano}</span>
                    <button onclick="mudarMes(1)" class="px-2 text-lg hover:text-theme">›</button>
                `;

                const primeiroDiaExibido = new Date(ano, mes, 1).getDay();
                const diasNoMes = new Date(ano, mes + 1, 0).getDate();

                for (let j = 0; j < primeiroDiaExibido; j++) { grid.appendChild(document.createElement('div')); }

                // Pega dados do profissional (Segurança: array vazio se indefinido)
                const profDados = PROFISSIONAIS_ALL.find(p => p.id === selectedProfessional);
                const diasTrabalhoProf = (profDados && profDados.dias_trabalho) ? profDados.dias_trabalho : [0,1,2,3,4,5,6]; 
                const folgasProf = (profDados && profDados.folgas) ? profDados.folgas : []; 

                let bloqueios = {
                    feriados: FERIADOS.map(f => f.data || f), 
                    dias_recorrentes: DIAS_FECHADOS
                };

                for (let d = 1; d <= diasNoMes; d++) {
                    const data = new Date(ano, mes, d);
                    const iso = data.toISOString().split('T')[0];
                    const jsDay = data.getDay(); 
                    const pythonDay = { 0: 6, 1: 0, 2: 1, 3: 2, 4: 3, 5: 4, 6: 5 }[jsDay];

                    const ehPassado = data < hoje;
                    const ehFeriado = bloqueios.feriados.includes(iso);
                    const ehDiaFechadoSalao = bloqueios.dias_recorrentes.includes(pythonDay);
                    
                    // Bloqueio do Profissional
                    const profNaoTrabalha = !diasTrabalhoProf.includes(pythonDay);
                    const ehFolgaProf = folgasProf.includes(iso);

                    const estaBloqueado = ehPassado || ehFeriado || ehDiaFechadoSalao || profNaoTrabalha || ehFolgaProf;

                    const btn = document.createElement('button');
                    btn.innerText = d;
                    btn.className = `p-3 rounded-xl font-bold transition-all flex flex-col items-center justify-center h-12 shadow-sm border border-gray-100 `;

                    if (estaBloqueado) {
                        btn.className += `calendar-day disabled`;
                        btn.disabled = true;
                    } else {
                        btn.className += `bg-white text-gray-700 hover:bg-theme-light hover:text-theme hover:border-theme cursor-pointer`;
                        if (selectedDate === iso) btn.classList.add('day-selected');
                        btn.onclick = () => {
                            selectedDate = iso;
                            renderizarCalendario();
                            buscarHorarios(iso);
                        };
                    }
                    grid.appendChild(btn);
                }
            } catch(e) { console.error("Erro renderizarCalendario:", e); }
        }

        function mudarMes(delta) {
            mesAtual.setMonth(mesAtual.getMonth() + delta);
            renderizarCalendario();
        }

        async function buscarHorarios(iso) {
            const container = document.getElementById('lista-horarios');
            document.getElementById('section-horarios').classList.remove('hidden');
            container.innerHTML = '<p class="col-span-full text-center text-theme font-bold p-4">Consultando horários...</p>';
            try {
                const res = await fetch(`${BASE_URL}/disponibilidade/${iso}?service_id=${selectedService}&professional_id=${selectedProfessional}`);
                const data = await res.json();
                const profData = data.find(p => p.professional_id == selectedProfessional);
                container.innerHTML = '';
                if (!profData || !profData.horarios || profData.horarios.length === 0) {
                    container.innerHTML = '<p class="col-span-full text-center text-gray-400 font-bold p-4 bg-gray-50 rounded-2xl italic">Nenhum horário disponível.</p>';
                    return;
                }
                profData.horarios.forEach(h => {
                    const btn = document.createElement('button');
                    btn.className = "slot-btn bg-white rounded-2xl py-4 text-sm font-black text-gray-700 shadow-sm";
                    btn.innerText = h;
                    btn.onclick = () => {
                        selectedTime = h;
                        document.querySelectorAll('.slot-btn').forEach(b => b.classList.remove('slot-selected'));
                        btn.classList.add('slot-selected');
                        document.getElementById('section-finalizar').classList.remove('hidden');
                        document.getElementById('section-finalizar').scrollIntoView({behavior:'smooth'});
                    };
                    container.appendChild(btn);
                });
                document.getElementById('section-horarios').scrollIntoView({behavior:'smooth'});
            } catch(e) {
                container.innerHTML = '<p class="col-span-full text-center text-red-400">Erro na consulta.</p>';
            }
        }

        function mostrarErro(mensagem) {
            document.getElementById('msg-erro-texto').innerText = mensagem;
            document.getElementById('modal-erro').classList.remove('hidden');
        }
        function fecharModalErro() { document.getElementById('modal-erro').classList.add('hidden'); }
        function reloadPage() { location.reload(); }

        async function finalizarReserva() {
            const nome = document.getElementById('cliente-nome').value;
            const fone = document.getElementById('cliente-whatsapp').value;
            if (!nome || fone.length < 14) return mostrarErro("Preencha seu nome e um telefone completo.");
            
            const btn = document.getElementById('btn-confirmar');
            btn.disabled = true;
            btn.innerText = "Processando...";
            
            const siteKey = "{{ turnstile_site_key|default:'' }}";
            if (siteKey && typeof turnstile !== 'undefined' && turnstileWidgetId !== null) {
                try {
                    turnstile.execute(turnstileWidgetId);
                    return;
                } catch (e) { }
            }
            submitAgendamento(null);
        }

        async function submitAgendamento(token) {
            const nome = document.getElementById('cliente-nome').value;
            const fone = document.getElementById('cliente-whatsapp').value;
            const btn = document.getElementById('btn-confirmar');
            
            try {
                const res = await fetch(`${BASE_URL}/agendar`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        servico_id: selectedService,
                        profissional_id: selectedProfessional,
                        data: selectedDate,
                        horario: selectedTime,
                        nome_cliente: nome,
                        whatsapp: fone,
                        turnstile_token: token
                    })
                });
                const data = await res.json();
                if (res.ok) {
                    document.getElementById('modal-sucesso').classList.remove('hidden');
                    gerarVoucher(nome, fone, selectedDate, selectedTime, selectedServiceName, data.codigo);
                } else {
                    mostrarErro(data.message || "Erro.");
                    btn.disabled = false;
                    btn.innerText = "Confirmar Agendamento";
                }
            } catch(e) {
                mostrarErro("Erro de conexão.");
                btn.disabled = false;
                btn.innerText = "Confirmar Agendamento";
            }
        }

        let turnstileWidgetId = null;
        function turnstileOnload() {
            try {
                const siteKey = "{{ turnstile_site_key|default:'' }}";
                if (!siteKey) return;
                turnstileWidgetId = turnstile.render('#turnstile-widget', {
                    sitekey: siteKey, size: 'invisible',
                    callback: submitAgendamento
                });
            } catch (e) {}
        }

        const phoneInput = document.getElementById('cliente-whatsapp');
        if (phoneInput) {
            phoneInput.addEventListener('input', function (e) {
                let v = e.target.value.replace(/\D/g, ""); // Remove tudo que não é dígito
                
                // Limita a 11 dígitos
                if (v.length > 11) v = v.substring(0, 11);

                // Aplica a máscara
                if (v.length > 10) { 
                    // Celular com 11 dígitos: (11) 9 1234-5678
                    v = v.replace(/^(\d\d)(\d)(\d{4})(\d{4})/, "($1) $2 $3-$4");
                } else if (v.length > 5) {
                    // Fixo ou celular incompleto: (11) 1234-5678
                    v = v.replace(/^(\d\d)(\d{4})(\d{0,4})/, "($1) $2-$3");
                } else if (v.length > 2) {
                    // Apenas DDD: (11) 
                    v = v.replace(/^(\d\d)/, "($1) ");
                }
                
                e.target.value = v;
            });
        }

        function gerarVoucher(nome, tel, data, hora, servico, codigoBackend) {
            const safeNome = nome || "Cliente";
            const safeData = data ? data.split('-').reverse().join('/') : "--/--";
            const safeHora = hora || "--:--";
            const safeServico = servico || "Serviço";
            document.getElementById('v-nome').innerText = safeNome;
            document.getElementById('v-tel').innerText = tel;
            document.getElementById('v-data').innerText = safeData;
            document.getElementById('v-hora').innerText = safeHora;
            document.getElementById('v-servico').innerText = safeServico;
            document.getElementById('v-codigo').innerText = codigoBackend || "PENDENTE";
            setTimeout(() => {
                const elemento = document.getElementById('voucher-template');
                html2canvas(elemento, { scale: 2, backgroundColor: "#ffffff" }).then(canvas => {
                    const imgData = canvas.toDataURL("image/png");
                    document.getElementById('img-ticket-gerado').src = imgData;
                    document.getElementById('loading-ticket').classList.add('hidden');
                    document.getElementById('area-ticket-pronto').classList.remove('hidden');
                    const btnDown = document.getElementById('btn-download-ticket');
                    btnDown.href = imgData;
                    btnDown.download = `Voucher-${codigoBackend}.png`;
                });
            }, 500); 
        }
    </script>
</body>
</html>
{% endblock %}