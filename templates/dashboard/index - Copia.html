<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Painel Gestão - {{ salao.nome }}</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
   
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --cor-primaria: {{ salao.cor_do_tema|default:'#8E44AD' }};
            --cor-primaria-clara: color-mix(in srgb, var(--cor-primaria), white 90%);
        }
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; color: #1e293b; }
        .bg-theme { background-color: var(--cor-primaria); }
        .text-theme { color: var(--cor-primaria); }
        .border-theme { border-color: var(--cor-primaria); }
        .bg-theme-light { background-color: var(--cor-primaria-clara); }
       
        .sidebar-link { display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem 1rem; margin-bottom: 0.25rem; border-radius: 0.75rem; color: rgba(255,255,255,0.8); transition: all 0.2s; font-weight: 500; cursor: pointer; }
        .sidebar-link:hover, .sidebar-link.active { background-color: rgba(255,255,255,0.15); color: white; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
       
        .card { background: white; border-radius: 1.5rem; border: 1px solid #e2e8f0; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.02); overflow: hidden; }
        .card-header { padding: 1.5rem; border-bottom: 1px solid #f1f5f9; display: flex; align-items: center; justify-content: space-between; }
        .card-body { padding: 1.5rem; }
       
        .input-field { width: 100%; padding: 0.625rem 1rem; border-radius: 0.75rem; border: 1px solid #cbd5e1; background-color: #fff; transition: all 0.2s; outline: none; }
        .input-field:focus { border-color: var(--cor-primaria); box-shadow: 0 0 0 3px var(--cor-primaria-clara); }
       
        .modal-backdrop { background-color: rgba(15, 23, 42, 0.6); backdrop-filter: blur(4px); }
        .modal-content { animation: modalUp 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes modalUp { from { opacity: 0; transform: translateY(20px) scale(0.95); } to { opacity: 1; transform: translateY(0) scale(1); } }
       
        .color-dot { width: 32px; height: 32px; border-radius: 50%; cursor: pointer; border: 2px solid white; box-shadow: 0 0 0 2px #e2e8f0; transition: transform 0.2s; }
        .color-dot:hover { transform: scale(1.15); }
       
        .toast { position: fixed; top: 20px; right: 20px; z-index: 9999; background: white; border-radius: 1rem; padding: 1rem 1.5rem; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); border-left: 6px solid var(--cor-primaria); display: flex; align-items: center; gap: 1rem; transform: translateX(120%); transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        .toast.show { transform: translateX(0); }
       
        .check-card:checked + div { background-color: var(--cor-primaria); color: white; border-color: var(--cor-primaria); box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
        .check-dia:checked + span { background-color: var(--cor-primaria); color: white; border-color: var(--cor-primaria); transform: scale(1.05); box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        .hidden { display: none; }
        .animate-fade { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="flex min-h-screen overflow-hidden">
    {{ servicos|json_script:"d-servicos" }}
    {{ profissionais|json_script:"d-profissionais" }}
    {{ feriados|json_script:"d-feriados" }}
    {{ folgas|json_script:"d-folgas" }}
    {{ categorias|json_script:"d-categorias" }}
    <aside class="w-72 bg-theme text-white flex flex-col h-screen fixed left-0 top-0 z-20 shadow-xl transition-all">
        <div class="p-6 pb-2">
            <div class="flex items-center gap-3 mb-6">
                <div class="w-10 h-10 rounded-xl bg-white/20 flex items-center justify-center backdrop-blur-sm"><i data-lucide="scissors" class="w-6 h-6 text-white"></i></div>
                <div><h1 class="font-bold text-lg leading-tight">{{ salao.nome }}</h1><p class="text-xs text-white/70">Painel Administrativo</p></div>
            </div>
        </div>
        <nav class="flex-1 px-4 space-y-1 overflow-y-auto">
            <button onclick="switchTab('agenda')" class="sidebar-link w-full active" id="btn-agenda"><i data-lucide="calendar-check-2" class="w-5 h-5"></i> Agendamentos</button>
            <button onclick="switchTab('servicos')" class="sidebar-link w-full" id="btn-servicos"><i data-lucide="gem" class="w-5 h-5"></i> Serviços</button>
            <button onclick="switchTab('equipe')" class="sidebar-link w-full" id="btn-equipe"><i data-lucide="users" class="w-5 h-5"></i> Equipe</button>
            <button onclick="switchTab('ausencias')" class="sidebar-link w-full" id="btn-ausencias"><i data-lucide="calendar-off" class="w-5 h-5"></i> Folgas/Feriados</button>
            <button onclick="switchTab('config')" class="sidebar-link w-full" id="btn-config"><i data-lucide="settings-2" class="w-5 h-5"></i> Configurações</button>
            <button onclick="abrirModalLogout()" class="sidebar-link w-full" id="btn-logout"><i data-lucide="log-out" class="w-5 h-5"></i> Sair</button>
        </nav>
        <div class="p-4 mt-auto bg-black/10 backdrop-blur-sm">
            <div class="bg-white rounded-xl p-3 shadow-lg">
                <div class="flex items-center gap-3 mb-3">
                    <div id="qrcode" class="w-16 h-16 flex-shrink-0"></div>
                    <div class="overflow-hidden">
                        <p class="text-xs font-bold text-gray-500 uppercase tracking-wider mb-1">Seu Link</p>
                        <button onclick="copiarLink()" class="text-xs font-semibold text-theme bg-theme-light px-2 py-1 rounded-md hover:opacity-80 transition flex items-center gap-1 w-full justify-center"><i data-lucide="copy" class="w-3 h-3"></i> Copiar Link</button>
                    </div>
                </div>
            </div>
        </div>
    </aside>
    <main class="flex-1 ml-72 h-screen overflow-y-auto p-6 lg:p-10 relative">
        <section id="tab-agenda" class="tab-content animate-fade">
            <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-8">
                <div><h2 class="text-3xl font-extrabold text-slate-800">Agendamentos</h2><p class="text-slate-500">Gerencie sua agenda diária.</p></div>
                <div class="flex flex-wrap items-center gap-2 bg-white p-2 rounded-2xl shadow-sm border border-gray-100">
                    <div class="px-2 text-gray-400"><i data-lucide="filter" class="w-4 h-4"></i></div>
                    <input type="date" id="filtroData" onchange="filtrarAgenda()" class="input-field !w-auto !py-2 !border-0 bg-transparent text-sm font-semibold text-gray-600 focus:ring-0 cursor-pointer">
                    <div class="w-px h-6 bg-gray-200 mx-1"></div>
                    <select id="filtroProfissional" onchange="filtrarAgenda()" class="input-field !w-auto !py-2 !border-0 bg-transparent text-sm font-semibold text-gray-600 focus:ring-0 cursor-pointer min-w-[150px]"><option value="">Todos Profissionais</option></select>
                    <button onclick="limparFiltros()" class="ml-2 p-2 rounded-xl text-slate-400 hover:text-red-500 hover:bg-red-50 transition"><i data-lucide="x" class="w-4 h-4"></i></button>
                </div>
            </div>
            <div class="card">
                <div class="overflow-x-auto">
                    <table class="w-full text-left border-collapse">
                        <thead>
                            <tr class="bg-slate-50 border-b border-slate-100 text-xs font-bold text-slate-500 uppercase tracking-wider">
                                <th class="p-4">Cód.</th>
                                <th class="p-4">Data/Hora</th>
                                <th class="p-4">Cliente</th>
                                <th class="p-4">Serviço</th>
                                <th class="p-4">Profissional</th>
                                <th class="p-4 text-center">Ações</th>
                            </tr>
                        </thead>
                        <tbody class="text-sm text-slate-700 divide-y divide-slate-50" id="tabelaAgendamentos">
                            {% include "dashboard/partials/lista_agendamentos.html" %}
                        </tbody>
                    </table>
                    <div id="msgSemResultados" class="hidden p-10 text-center text-slate-400"><i data-lucide="search-x" class="w-12 h-12 mx-auto mb-3 opacity-20"></i><p>Nenhum agendamento para este filtro.</p></div>
                </div>
            </div>
        </section>
        <section id="tab-servicos" class="tab-content hidden animate-fade">
             <div class="flex items-center justify-between mb-8">
                 <div><h2 class="text-3xl font-extrabold text-slate-800">Serviços</h2></div>
                 <div class="flex gap-2">
                     <button onclick="abrirModalCategorias()" class="bg-white border border-slate-200 text-slate-700 px-5 py-3 rounded-xl font-bold shadow-sm hover:bg-slate-50 flex items-center gap-2"><i data-lucide="layers" class="w-5 h-5"></i> Categorias</button>
                     <button onclick="abrirModalServico()" class="bg-theme text-white px-5 py-3 rounded-xl font-bold shadow-lg hover:opacity-90 flex items-center gap-2"><i data-lucide="plus-circle" class="w-5 h-5"></i> Novo Serviço</button>
                 </div>
             </div>
             <div id="gridServicos" class="space-y-8"></div>
        </section>
        <section id="tab-equipe" class="tab-content hidden animate-fade">
             <div class="flex items-center justify-between mb-8">
                 <div><h2 class="text-3xl font-extrabold text-slate-800">Equipe</h2></div>
                 <button onclick="abrirModalProfissional()" class="bg-theme text-white px-5 py-3 rounded-xl font-bold shadow-lg hover:opacity-90 flex items-center gap-2"><i data-lucide="user-plus" class="w-5 h-5"></i> Novo Profissional</button>
             </div>
             <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6" id="gridProfissionais"></div>
        </section>
       
        <section id="tab-ausencias" class="tab-content hidden animate-fade">
             <div class="flex items-center justify-between mb-8">
                 <div><h2 class="text-3xl font-extrabold text-slate-800">Ausências</h2></div>
                 <div class="flex gap-3"><button onclick="abrirModalFeriado()" class="bg-white border border-slate-200 text-slate-700 px-4 py-2 rounded-xl font-bold hover:bg-slate-50 flex items-center gap-2"><i data-lucide="calendar" class="w-4 h-4"></i> Feriado</button><button onclick="abrirModalFolga()" class="bg-theme text-white px-4 py-2 rounded-xl font-bold hover:opacity-90 flex items-center gap-2"><i data-lucide="coffee" class="w-4 h-4"></i> Nova Folga</button></div>
             </div>
             <div class="grid lg:grid-cols-2 gap-6">
                 <div class="card">
                     <div class="card-header bg-slate-50/50"><div class="font-bold text-slate-700 flex items-center gap-2"><i data-lucide="flag" class="w-4 h-4 text-red-500"></i> Feriados Globais</div></div>
                     <div class="card-body space-y-2" id="listaFeriados"></div>
                 </div>
                 <div class="card">
                     <div class="card-header bg-slate-50/50"><div class="font-bold text-slate-700 flex items-center gap-2"><i data-lucide="user-x" class="w-4 h-4 text-orange-500"></i> Folgas Individuais</div></div>
                     <div class="card-body">
                         <div class="grid grid-cols-4 text-xs font-bold text-slate-500 uppercase tracking-wider mb-2 border-b pb-2">
                             <div class="col-span-2">Profissional / Data</div>
                             <div>Período</div>
                             <div class="text-right">Ação</div>
                         </div>
                         <div class="space-y-2" id="listaFolgas"></div>
                     </div>
                 </div>
             </div>
        </section>
        <section id="tab-config" class="tab-content hidden animate-fade">
             <div class="flex items-center justify-between mb-8"><div><h2 class="text-3xl font-extrabold text-slate-800">Configurações</h2></div><button onclick="salvarConfigGeral()" class="bg-theme text-white px-6 py-3 rounded-xl font-bold shadow-lg hover:opacity-90 flex items-center gap-2"><i data-lucide="save" class="w-5 h-5"></i> Salvar Tudo</button></div>
             <div class="grid gap-6">
                <div class="card"><div class="card-header"><span class="font-bold">Tema & Cores</span></div><div class="card-body"><div class="flex flex-wrap gap-4"><div class="color-dot" style="background-color: #334155;" onclick="mudarCor('#334155')"></div><div class="color-dot" style="background-color: #0f766e;" onclick="mudarCor('#0f766e')"></div><div class="color-dot" style="background-color: #2563eb;" onclick="mudarCor('#2563eb')"></div><div class="color-dot" style="background-color: #7c3aed;" onclick="mudarCor('#7c3aed')"></div><div class="color-dot" style="background-color: #db2777;" onclick="mudarCor('#db2777')"></div><div class="color-dot" style="background-color: #dc2626;" onclick="mudarCor('#dc2626')"></div><div class="color-dot" style="background-color: #ea580c;" onclick="mudarCor('#ea580c')"></div><div class="color-dot" style="background-color: #16a34a;" onclick="mudarCor('#16a34a')"></div><div class="color-dot" style="background-color: #8E44AD;" onclick="mudarCor('#8E44AD')"></div><div class="color-dot" style="background-color: #000000;" onclick="mudarCor('#000000')"></div></div></div></div>
                <div class="card">
                    <div class="card-header"><span class="font-bold">Dados do Estabelecimento</span></div>
                    <div class="card-body grid md:grid-cols-2 gap-4">
                        <div class="md:col-span-2"><label class="text-sm font-bold text-slate-700">Nome / Razão Social</label><input id="cfg_nome" value="{{ salao.nome }}" class="input-field mt-1"></div>
                        <div><label class="text-sm font-bold text-slate-700">CPF / CNPJ</label><input id="cfg_doc" value="{{ salao.cnpj_cpf|default:'' }}" class="input-field mt-1" placeholder="00.000.000/0000-00" maxlength="18" oninput="mascaraDoc(this)"></div>
                        <div><label class="text-sm font-bold text-slate-700">Telefone / WhatsApp</label><input id="cfg_tel" value="{{ salao.telefone|default:'' }}" class="input-field mt-1" placeholder="(00) 0 0000-0000" maxlength="16" oninput="mascaraTel(this)"></div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header"><span class="font-bold">Preferências</span></div>
                    <div class="card-body">
                        <div class="flex items-center justify-between">
                            <div><h4 class="font-bold text-slate-700">Ocultar Preços</h4><p class="text-xs text-slate-500">Oculta valores no agendamento.</p></div>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="cfg_ocultar_precos" class="sr-only peer" {% if salao.ocultar_precos %}checked{% endif %}>
                                <div class="w-11 h-6 bg-slate-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-theme"></div>
                            </label>
                        </div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header"><span class="font-bold">Endereço</span></div>
                    <div class="card-body">
                        <input type="hidden" id="endereco_full" value='{{ salao.endereco|default:""|safe }}'>
                        <div class="grid md:grid-cols-4 gap-4 mb-4">
                            <div><label class="text-sm font-bold text-slate-700">CEP</label><div class="relative"><input id="cep" class="input-field mt-1" placeholder="00000-000" maxlength="9" onblur="buscarCep()" oninput="mascaraCep(this)"><i data-lucide="search" class="absolute right-3 top-4 w-4 h-4 text-gray-400"></i></div></div>
                            <div class="md:col-span-3"><label class="text-sm font-bold text-slate-700">Rua / Logradouro</label><input id="logradouro" class="input-field mt-1 bg-slate-50"></div>
                        </div>
                        <div class="grid md:grid-cols-4 gap-4">
                            <div><label class="text-sm font-bold text-slate-700">Número</label><input id="numero" class="input-field mt-1"></div>
                            <div><label class="text-sm font-bold text-slate-700">Complemento</label><input id="complemento" class="input-field mt-1"></div>
                            <div><label class="text-sm font-bold text-slate-700">Bairro</label><input id="bairro" class="input-field mt-1 bg-slate-50"></div>
                            <div><label class="text-sm font-bold text-slate-700">Cidade/UF</label><input id="cidade" class="input-field mt-1 bg-slate-50"></div>
                        </div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header"><span class="font-bold">Horário de Funcionamento</span></div>
                    <div class="card-body">
                        <div class="grid md:grid-cols-3 gap-4 mb-6">
                            <div><label class="text-sm font-bold text-slate-700">Abertura</label><input type="time" id="horaAbertura" value="{{ salao.hora_abertura_padrao|time:'H:i' }}" class="input-field mt-1"></div>
                            <div><label class="text-sm font-bold text-slate-700">Fechamento</label><input type="time" id="horaFechamento" value="{{ salao.hora_fechamento_padrao|time:'H:i' }}" class="input-field mt-1"></div>
                            <div><label class="text-sm font-bold text-slate-700">Intervalo Slots</label><input type="number" id="intervaloMinutos" value="{{ salao.intervalo_minutos }}" class="input-field mt-1"></div>
                        </div>
                        <label class="text-sm font-bold text-slate-700 mb-2 block">Dias Fechados</label>
                        <div class="flex flex-wrap gap-2">
                            <label class="cursor-pointer select-none"><input type="checkbox" class="diaFechado check-dia hidden peer" value="0"><span class="px-4 py-2 rounded-xl border border-slate-200 text-slate-500 font-bold transition-all peer-checked:bg-theme peer-checked:text-white peer-checked:border-transparent">Segunda</span></label>
                            <label class="cursor-pointer select-none"><input type="checkbox" class="diaFechado check-dia hidden peer" value="1"><span class="px-4 py-2 rounded-xl border border-slate-200 text-slate-500 font-bold transition-all peer-checked:bg-theme peer-checked:text-white peer-checked:border-transparent">Terça</span></label>
                            <label class="cursor-pointer select-none"><input type="checkbox" class="diaFechado check-dia hidden peer" value="2"><span class="px-4 py-2 rounded-xl border border-slate-200 text-slate-500 font-bold transition-all peer-checked:bg-theme peer-checked:text-white peer-checked:border-transparent">Quarta</span></label>
                            <label class="cursor-pointer select-none"><input type="checkbox" class="diaFechado check-dia hidden peer" value="3"><span class="px-4 py-2 rounded-xl border border-slate-200 text-slate-500 font-bold transition-all peer-checked:bg-theme peer-checked:text-white peer-checked:border-transparent">Quinta</span></label>
                            <label class="cursor-pointer select-none"><input type="checkbox" class="diaFechado check-dia hidden peer" value="4"><span class="px-4 py-2 rounded-xl border border-slate-200 text-slate-500 font-bold transition-all peer-checked:bg-theme peer-checked:text-white peer-checked:border-transparent">Sexta</span></label>
                            <label class="cursor-pointer select-none"><input type="checkbox" class="diaFechado check-dia hidden peer" value="5"><span class="px-4 py-2 rounded-xl border border-slate-200 text-slate-500 font-bold transition-all peer-checked:bg-theme peer-checked:text-white peer-checked:border-transparent">Sábado</span></label>
                            <label class="cursor-pointer select-none"><input type="checkbox" class="diaFechado check-dia hidden peer" value="6"><span class="px-4 py-2 rounded-xl border border-slate-200 text-slate-500 font-bold transition-all peer-checked:bg-theme peer-checked:text-white peer-checked:border-transparent">Domingo</span></label>
                        </div>
                        <hr class="my-4 border-slate-100">
                        <h4 class="font-bold text-slate-700 mb-2">Horários Personalizados (Ex: Sábado reduzido)</h4>
                        <div id="lista-horarios-custom" class="space-y-2"></div>
                        <textarea id="horarios_custom_json" class="hidden">{{ salao.horarios_customizados|default:'{}'|safe }}</textarea>
                    </div>
                </div>
             </div>
        </section>
    </main>
    <div id="toast" class="toast"><div id="toastIcon"></div><div><h4 id="toastTitle" class="font-bold text-sm text-slate-900">Sucesso</h4><p id="toastMsg" class="text-sm text-slate-600">Operação realizada.</p></div></div>
    <div id="modal-confirm-delete" class="hidden fixed inset-0 z-[60] flex items-center justify-center">
        <div class="absolute inset-0 modal-backdrop" onclick="fecharModalDelete()"></div>
        <div class="modal-content relative bg-white w-full max-w-sm rounded-2xl shadow-2xl p-6 text-center z-10 m-4">
            <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
                <i data-lucide="alert-triangle" class="w-8 h-8 text-red-600"></i>
            </div>
            <h3 class="text-xl font-bold text-slate-800 mb-2">Tem certeza?</h3>
            <p class="text-sm text-slate-500 mb-6">Essa ação não poderá ser desfeita.</p>
           
            <div class="flex gap-3 justify-center">
                <button onclick="fecharModalDelete()" class="px-5 py-3 rounded-xl border border-slate-200 text-slate-600 font-bold hover:bg-slate-50 transition w-full">Cancelar</button>
                <button id="btn-confirm-delete" class="px-5 py-3 rounded-xl bg-red-500 text-white font-bold hover:bg-red-600 transition shadow-lg shadow-red-200 w-full">Excluir</button>
            </div>
        </div>
    </div>
    <div id="modal-logout" class="hidden fixed inset-0 z-50 flex items-center justify-center">
        <div class="absolute inset-0 modal-backdrop" onclick="document.getElementById('modal-logout').classList.add('hidden')"></div>
        <div class="modal-content relative bg-white w-full max-w-sm rounded-2xl shadow-2xl p-6 text-center z-10 m-4">
            <div class="w-16 h-16 bg-slate-100 rounded-full flex items-center justify-center mx-auto mb-4"><i data-lucide="log-out" class="w-8 h-8 text-slate-700"></i></div>
            <h3 class="text-xl font-bold text-slate-800 mb-2">Encerrar sessão</h3>
            <div class="flex gap-3 justify-center mt-4">
                <button onclick="document.getElementById('modal-logout').classList.add('hidden')" class="px-5 py-2.5 rounded-xl border border-slate-200 text-slate-600 font-bold hover:bg-slate-50 transition">Cancelar</button>
                <form action="{% url 'logout' %}" method="post">{% csrf_token %}<button type="submit" class="px-5 py-2.5 rounded-xl bg-red-500 text-white font-bold hover:bg-red-600 transition shadow-lg shadow-red-200">Sair</button></form>
            </div>
        </div>
    </div>
    <div id="modal-categorias" class="hidden fixed inset-0 z-50 flex items-center justify-center">
        <div class="absolute inset-0 modal-backdrop" onclick="fecharModalCategorias()"></div>
        <div class="modal-content relative bg-white w-full max-w-md rounded-2xl shadow-2xl overflow-hidden z-10 m-4 flex flex-col max-h-[80vh]">
            <div class="bg-theme p-5 text-white flex justify-between items-center shrink-0">
                <h3 class="font-bold text-lg">Gerenciar Categorias</h3>
                <button onclick="fecharModalCategorias()"><i data-lucide="x" class="w-6 h-6"></i></button>
            </div>
            <div class="p-6 space-y-4 overflow-y-auto">
                <input type="hidden" id="cat_id_edicao">
                <div class="flex gap-2">
                    <input type="text" id="cat_nome_nova" class="input-field" placeholder="Nome da Categoria (ex: Barba)">
                    <button id="btn-save-cat" onclick="salvarCategoria()" class="bg-theme text-white px-4 rounded-xl font-bold shadow-md hover:opacity-90"><i data-lucide="plus" class="w-5 h-5"></i></button>
                </div>
                <hr class="border-gray-100">
                <div id="lista_categorias_modal" class="space-y-2"></div>
            </div>
        </div>
    </div>
    <div id="modal-servico" class="hidden fixed inset-0 z-50 flex items-center justify-center">
        <div class="absolute inset-0 modal-backdrop" onclick="document.getElementById('modal-servico').classList.add('hidden')"></div>
        <div class="modal-content relative bg-white w-full max-w-md rounded-2xl shadow-2xl overflow-hidden z-10 m-4">
            <div class="bg-theme p-5 text-white flex justify-between items-center"><h3 class="font-bold text-lg">Serviço</h3><button onclick="document.getElementById('modal-servico').classList.add('hidden')"><i data-lucide="x" class="w-6 h-6"></i></button></div>
            <div class="p-6 space-y-4">
                <input type="hidden" id="ms_id">
                <div><label class="text-sm font-bold text-slate-700">Categoria</label><select id="ms_cat" class="input-field mt-1"><option value="">Sem Categoria</option></select></div>
                <div><label class="text-sm font-bold text-slate-700">Nome</label><input id="ms_nome" class="input-field mt-1" placeholder="Ex: Corte Degrade"></div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="text-sm font-bold text-slate-700">Preço (R$)</label><input id="ms_preco" type="text" inputmode="numeric" class="input-field mt-1" placeholder="0,00" oninput="mascaraMoeda(this)"></div>
                    <div><label class="text-sm font-bold text-slate-700">Duração (min)</label><input id="ms_duracao" type="number" class="input-field mt-1" placeholder="30"></div>
                </div>
                <button onclick="salvarServico()" class="w-full bg-theme text-white font-bold py-3 rounded-xl hover:opacity-90 transition mt-2">Salvar Serviço</button>
            </div>
        </div>
    </div>
    <div id="modal-profissional" class="hidden fixed inset-0 z-50 flex items-center justify-center">
        <div class="absolute inset-0 modal-backdrop" onclick="document.getElementById('modal-profissional').classList.add('hidden')"></div>
        <div class="modal-content relative bg-white w-full max-w-2xl rounded-2xl shadow-2xl overflow-hidden z-10 m-4 flex flex-col max-h-[90vh]">
            <div class="px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-white shrink-0">
                <h3 class="font-bold text-xl text-slate-800">Profissional</h3>
                <button onclick="document.getElementById('modal-profissional').classList.add('hidden')" class="p-2 rounded-full hover:bg-slate-100"><i data-lucide="x" class="w-6 h-6"></i></button>
            </div>
            <div class="p-6 space-y-6 overflow-y-auto">
                <input type="hidden" id="mp_id">
               
                <div class="flex items-center gap-6">
                    <div class="relative group">
                        <div id="preview-foto-container" class="w-24 h-24 rounded-full bg-slate-100 border-2 border-dashed border-slate-300 flex items-center justify-center overflow-hidden relative">
                            <i data-lucide="camera" class="w-8 h-8 text-slate-400" id="icon-camera"></i>
                            <img id="preview-foto" src="" class="w-full h-full object-cover hidden">
                        </div>
                        <label for="mp_foto" class="absolute bottom-0 right-0 bg-theme text-white p-1.5 rounded-full shadow-md cursor-pointer hover:bg-opacity-90">
                            <i data-lucide="upload" class="w-4 h-4"></i>
                        </label>
                        <input type="file" id="mp_foto" class="hidden" accept="image/*" onchange="previewImagem(this)">
                    </div>
                    <div class="flex-1">
                        <h4 class="font-bold text-slate-700">Foto de Perfil</h4>
                        <p class="text-xs text-slate-500 mb-2">Recomendado: Quadrada (ex: 500x500px)</p>
                        <button type="button" onclick="removerFoto()" id="btn-remover-foto" class="text-red-500 text-xs font-bold hover:underline hidden">Remover foto atual</button>
                        <input type="hidden" id="mp_remover_foto" value="false">
                    </div>
                </div>
                <div class="grid md:grid-cols-2 gap-5">
                    <div><label class="text-sm font-bold text-slate-700 mb-1 block">Nome</label><input id="mp_nome" class="input-field"></div>
                    <div><label class="text-sm font-bold text-slate-700 mb-1 block">Especialidade</label><input id="mp_esp" class="input-field"></div>
                </div>
               
                <div>
                    <label class="text-sm font-bold text-slate-700 mb-3 block">Serviços Realizados</label>
                    <div id="mp_lista_servicos" class="space-y-4"></div>
                </div>
                <div class="bg-slate-50 rounded-2xl p-5 border border-slate-100">
                    <h4 class="text-sm font-bold text-slate-800 mb-4">Jornada de Trabalho</h4>
                    <div class="flex flex-wrap gap-3 justify-center sm:justify-start mb-4">
                        <label class="cursor-pointer select-none"><input type="checkbox" class="mp_dias check-dia hidden peer" value="0"><span class="w-12 h-12 flex items-center justify-center rounded-xl bg-white border border-slate-200 text-slate-400 font-bold transition-all peer-checked:bg-theme peer-checked:text-white peer-checked:border-theme peer-checked:shadow-lg">Seg</span></label>
                        <label class="cursor-pointer select-none"><input type="checkbox" class="mp_dias check-dia hidden peer" value="1"><span class="w-12 h-12 flex items-center justify-center rounded-xl bg-white border border-slate-200 text-slate-400 font-bold transition-all peer-checked:bg-theme peer-checked:text-white peer-checked:border-theme peer-checked:shadow-lg">Ter</span></label>
                        <label class="cursor-pointer select-none"><input type="checkbox" class="mp_dias check-dia hidden peer" value="2"><span class="w-12 h-12 flex items-center justify-center rounded-xl bg-white border border-slate-200 text-slate-400 font-bold transition-all peer-checked:bg-theme peer-checked:text-white peer-checked:border-theme peer-checked:shadow-lg">Qua</span></label>
                        <label class="cursor-pointer select-none"><input type="checkbox" class="mp_dias check-dia hidden peer" value="3"><span class="w-12 h-12 flex items-center justify-center rounded-xl bg-white border border-slate-200 text-slate-400 font-bold transition-all peer-checked:bg-theme peer-checked:text-white peer-checked:border-theme peer-checked:shadow-lg">Qui</span></label>
                        <label class="cursor-pointer select-none"><input type="checkbox" class="mp_dias check-dia hidden peer" value="4"><span class="w-12 h-12 flex items-center justify-center rounded-xl bg-white border border-slate-200 text-slate-400 font-bold transition-all peer-checked:bg-theme peer-checked:text-white peer-checked:border-theme peer-checked:shadow-lg">Sex</span></label>
                        <label class="cursor-pointer select-none"><input type="checkbox" class="mp_dias check-dia hidden peer" value="5"><span class="w-12 h-12 flex items-center justify-center rounded-xl bg-white border border-slate-200 text-slate-400 font-bold transition-all peer-checked:bg-theme peer-checked:text-white peer-checked:border-theme peer-checked:shadow-lg">Sáb</span></label>
                        <label class="cursor-pointer select-none"><input type="checkbox" class="mp_dias check-dia hidden peer" value="6"><span class="w-12 h-12 flex items-center justify-center rounded-xl bg-white border border-slate-200 text-slate-400 font-bold transition-all peer-checked:bg-theme peer-checked:text-white peer-checked:border-theme peer-checked:shadow-lg">Dom</span></label>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                         <div><label class="text-xs font-bold text-slate-500 uppercase mb-1 block">Início</label><input type="time" id="mp_inicio" class="input-field" value="09:00"></div>
                         <div><label class="text-xs font-bold text-slate-500 uppercase mb-1 block">Fim</label><input type="time" id="mp_fim" class="input-field" value="18:00"></div>
                    </div>
                </div>
                <div>
                    <label class="text-sm font-bold text-slate-700 mb-2 block">Pausas/Intervalos</label>
                    <div class="flex gap-2 mb-3">
                        <input type="time" id="mp_int_ini" class="input-field flex-1">
                        <span class="self-center font-bold">-</span>
                        <input type="time" id="mp_int_fim" class="input-field flex-1">
                        <button onclick="addIntervalo()" class="bg-slate-800 text-white p-2.5 rounded-xl"><i data-lucide="plus" class="w-5 h-5"></i></button>
                    </div>
                    <div id="lista_intervalos" class="space-y-2"></div>
                </div>
            </div>
            <div class="p-6 border-t border-slate-100 bg-white shrink-0">
                <button onclick="salvarProfissional()" class="w-full bg-theme text-white font-bold py-3.5 rounded-xl hover:opacity-90 transition">Salvar Profissional</button>
            </div>
        </div>
    </div>
    <div id="modal-feriado" class="hidden fixed inset-0 z-50 flex items-center justify-center">
        <div class="absolute inset-0 modal-backdrop" onclick="document.getElementById('modal-feriado').classList.add('hidden')"></div>
        <div class="modal-content relative bg-white w-full max-w-sm rounded-2xl shadow-xl z-10 overflow-hidden">
            <div class="bg-theme p-4 text-white flex justify-between items-center">
                <h3 class="font-bold text-lg" id="titulo-modal-feriado">Novo Feriado</h3>
                <button onclick="document.getElementById('modal-feriado').classList.add('hidden')"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <div class="p-6">
                <input type="hidden" id="mf_id">
                <input type="date" id="mf_data" class="input-field mb-3">
                <input type="text" id="mf_desc" class="input-field mb-3" placeholder="Descrição (ex: Natal)">
               
                <div class="flex items-center justify-between mb-3 border-t pt-3">
                    <span class="text-sm font-bold text-slate-700">O dia todo?</span>
                    <input type="checkbox" id="mf_diatodo" class="w-5 h-5 accent-theme" onchange="toggleFeriadoDiaTodo()" checked>
                </div>
               
                <div id="container-horas-feriado" class="grid grid-cols-2 gap-3 opacity-50 pointer-events-none mb-4">
                    <div><label class="text-xs text-slate-500">Início Fechamento</label><input type="time" id="mf_ini" class="input-field"></div>
                    <div><label class="text-xs text-slate-500">Fim Fechamento</label><input type="time" id="mf_fim" class="input-field"></div>
                </div>
               
                <button onclick="salvarNovoFeriado()" class="w-full bg-theme text-white py-2 rounded-xl font-bold">Salvar</button>
            </div>
        </div>
    </div>
    <div id="modal-folga" class="hidden fixed inset-0 z-50 flex items-center justify-center"><div class="absolute inset-0 modal-backdrop" onclick="document.getElementById('modal-folga').classList.add('hidden')"></div><div class="modal-content relative bg-white w-full max-w-md rounded-2xl shadow-2xl overflow-hidden z-10 m-4"><div class="bg-theme p-5 text-white flex justify-between items-center"><h3 class="font-bold text-lg" id="titulo-modal-folga">Folga</h3><button onclick="document.getElementById('modal-folga').classList.add('hidden')"><i data-lucide="x" class="w-6 h-6"></i></button></div><div class="p-6 space-y-4"><input type="hidden" id="mfo_id"><div><label class="text-sm font-bold text-slate-700">Profissional</label><select id="mfo_prof" class="input-field mt-1"></select></div><div><label class="text-sm font-bold text-slate-700">Data</label><input type="date" id="mfo_data" class="input-field mt-1"></div><div class="flex items-center justify-between"><span class="text-sm font-bold text-slate-700">Dia Inteiro?</span><input type="checkbox" id="mfo_diatodo" class="w-5 h-5 accent-theme" onchange="toggleFolgaDiaTodo()" checked></div><div id="container-horas-folga" class="grid grid-cols-2 gap-3 opacity-50 pointer-events-none"><div><label class="text-xs text-slate-500">Início</label><input type="time" id="mfo_ini" class="input-field"></div><div><label class="text-xs text-slate-500">Fim</label><input type="time" id="mfo_fim" class="input-field"></div></div><button onclick="salvarNovaFolga()" class="w-full bg-theme text-white font-bold py-3 rounded-xl hover:opacity-90 mt-2">Salvar Folga</button></div></div></div>
    <div id="modal-erro-api" class="hidden fixed inset-0 z-[70] flex items-center justify-center">
        <div class="absolute inset-0 modal-backdrop" onclick="fecharModalErro()"></div>
        <div class="modal-content relative bg-white w-full max-w-sm rounded-2xl shadow-2xl overflow-hidden z-10 m-4">
            <div class="bg-theme p-5 text-white flex justify-between items-center">
                <h3 class="font-bold text-lg flex items-center gap-2">
                    <i data-lucide="alert-circle" class="w-6 h-6"></i> Atenção
                </h3>
                <button onclick="fecharModalErro()" class="hover:bg-white/20 p-1 rounded-full transition">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            <div class="p-8 text-center">
                <p id="msg-erro-api" class="text-slate-600 mb-8 leading-relaxed font-medium text-lg">Ocorreu um erro.</p>
                <button onclick="fecharModalErro()" class="w-full bg-theme text-white font-bold py-3.5 rounded-xl shadow-lg hover:opacity-90 transition transform active:scale-95">Entendi</button>
            </div>
        </div>
    </div>
<script>
    // --- 1. CONFIGURAÇÃO E UTILITÁRIOS (Pattern: Namespace) ---
    const CONFIG = {
        API_BASE: '/api/v1',
        SALON_ID: "{{ salao.id }}",
        SALON_SLUG: "{{ salao.slug }}",
    };
    // Dados Iniciais Django
    const STATE = {
        servicos: JSON.parse(document.getElementById('d-servicos').textContent),
        profissionais: JSON.parse(document.getElementById('d-profissionais').textContent),
        feriados: JSON.parse(document.getElementById('d-feriados').textContent),
        folgas: JSON.parse(document.getElementById('d-folgas').textContent),
        categorias: JSON.parse(document.getElementById('d-categorias').textContent),
        intervals: [], // Intervalos temporários de edição
        eventSource: null
    };
    const Utils = {
        // BLINDAGEM CONTRA XSS (Cross Site Scripting)
        escape: (str) => {
            if (!str) return '';
            const div = document.createElement('div');
            div.innerText = str;
            return div.innerHTML;
        },
        formatDate: (iso) => (!iso ? '-' : iso.split('-').reverse().join('/')),
        formatCurrency: (val) => parseFloat(val).toFixed(2).replace('.', ','),
        getCookie: (name) => {
            if (!document.cookie || document.cookie === '') return null;
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    return decodeURIComponent(cookie.substring(name.length + 1));
                }
            }
            return null;
        }
    };
    // --- 2. CORE API LAYER ---
    async function request(endpoint, method = 'GET', body = null) {
        // Normaliza URL evitando barras duplas ou falta de barra
        const url = endpoint.startsWith('http') ? endpoint : `${CONFIG.API_BASE}${endpoint.startsWith('/') ? '' : '/'}${endpoint}${endpoint.endsWith('/') || endpoint.includes('?') ? '' : '/'}`;
       
        const headers = { 'Content-Type': 'application/json' };
        if (method !== 'GET') headers['X-CSRFToken'] = Utils.getCookie('csrftoken');
        const config = { method, headers };
       
        if (body) {
            if (body instanceof FormData) {
                delete headers['Content-Type']; // Deixa o browser definir boundary
                config.body = body;
            } else {
                config.body = JSON.stringify(body);
            }
        }
        try {
            const r = await fetch(url, config);
            if (r.ok) {
                if (r.status === 204) return null;
                return await r.json();
            }
            // Tratamento de Erro Robusto
            const txt = await r.text();
            let errorMsg = "Ocorreu um erro desconhecido.";
            try {
                const json = JSON.parse(txt);
                // Extrai mensagem de erro do DRF (detail, non_field_errors, ou lista)
                errorMsg = json.detail || (Array.isArray(json) ? json[0] : null) || (json.non_field_errors ? json.non_field_errors[0] : null);
                if (!errorMsg) {
                    const keys = Object.keys(json);
                    if (keys.length > 0) errorMsg = `${keys[0]}: ${json[keys[0]]}`;
                }
            } catch (e) {
                errorMsg = txt.substring(0, 100); // Fallback para texto puro
            }
            throw new Error(errorMsg);
        } catch (e) {
            console.error("API Error:", e);
            mostrarErroApi(e.message);
            throw e;
        }
    }
    // --- 3. UI LOGIC & RENDERING ---
    // Renderização Otimizada (Batch DOM Update)
    function renderServicos() {
        const container = document.getElementById('gridServicos');
        const buffer = []; // Array buffer para evitar reflows constantes
        const renderGroup = (nomeCategoria, listaServicos) => {
            if (!listaServicos.length) return;
           
            // Header da Categoria
            buffer.push(`<h4 class="font-bold text-slate-400 uppercase text-xs border-b mb-2 mt-4 col-span-full">${Utils.escape(nomeCategoria)}</h4>`);
           
            // Grid
            buffer.push('<div class="grid md:grid-cols-2 xl:grid-cols-3 gap-6">');
           
            listaServicos.forEach(s => {
                const nomeSafe = Utils.escape(s.nome);
                const precoSafe = Utils.formatCurrency(s.preco);
               
                buffer.push(`
                    <div class="card p-5 group hover:shadow-lg transition">
                        <div class="flex justify-between items-start">
                            <div class="w-10 h-10 rounded-full bg-theme-light flex items-center justify-center text-theme font-bold">${nomeSafe[0]}</div>
                            <div class="flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                                <button onclick="abrirModalServico(${s.id})" class="text-blue-500 hover:bg-blue-50 p-1 rounded"><i data-lucide="edit-2" class="w-4 h-4"></i></button>
                                <button onclick="confirmarExclusao('servicos',${s.id})" class="text-red-500 hover:bg-red-50 p-1 rounded"><i data-lucide="trash" class="w-4 h-4"></i></button>
                            </div>
                        </div>
                        <h3 class="font-bold text-lg text-slate-800 leading-tight mt-3">${nomeSafe}</h3>
                        <p class="text-sm font-bold text-theme mt-1">R$ ${precoSafe}</p>
                        <div class="flex items-center gap-1 mt-3 text-xs text-slate-500"><i data-lucide="clock" class="w-3 h-3"></i> ${s.duracao_minutos} min</div>
                    </div>
                `);
            });
            buffer.push('</div>');
        };
        STATE.categorias.forEach(cat => renderGroup(cat.nome, STATE.servicos.filter(s => s.category_id == cat.id)));
        renderGroup("Sem Categoria", STATE.servicos.filter(s => !s.category_id));
        container.innerHTML = buffer.join(''); // Apenas UM reflow/repaint
        lucide.createIcons();
    }
    function renderProfissionais() {
        const container = document.getElementById('gridProfissionais');
        container.innerHTML = STATE.profissionais.map(p => {
            const nomeSafe = Utils.escape(p.nome);
            const espSafe = Utils.escape(p.especialidade || 'Profissional');
            const imgHtml = p.foto_url
                ? `<img src="${p.foto_url}" class="w-full h-full object-cover">`
                : `<img src="https://ui-avatars.com/api/?name=${encodeURIComponent(p.nome)}&background=random&size=128" class="w-full h-full">`;
            return `
            <div class="card p-6 flex flex-col items-center text-center h-full hover:shadow-lg transition-all group relative">
                <div class="absolute top-3 right-3 flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                    <button onclick="abrirModalProfissional(${p.id})" class="text-blue-500 hover:bg-blue-50 p-2 rounded-lg transition"><i data-lucide="edit-2" class="w-4 h-4"></i></button>
                    <button onclick="confirmarExclusao('profissionais',${p.id})" class="text-red-500 hover:bg-red-50 p-2 rounded-lg transition"><i data-lucide="trash" class="w-4 h-4"></i></button>
                </div>
                <div class="w-32 h-32 rounded-full border-4 border-slate-50 shadow-sm overflow-hidden mb-4 mt-2">
                    ${imgHtml}
                </div>
                <h3 class="font-bold text-xl text-slate-800 mb-1 leading-tight">${nomeSafe}</h3>
                <p class="text-sm font-medium text-theme bg-theme-light px-3 py-1 rounded-full mb-4 inline-block">${espSafe}</p>
                <div class="text-xs text-slate-400 mt-auto pt-4 border-t border-slate-50 w-full">
                    ${p.servicos_ids.length} serviços habilitados
                </div>
            </div>`;
        }).join('');
        lucide.createIcons();
    }
    function renderListasAusencias() {
        const feriadosHtml = STATE.feriados.map(f => {
            const periodo = (!f.hora_inicio) ? 'Dia todo' : `${f.hora_inicio.slice(0,5)} - ${f.hora_fim.slice(0,5)}`;
            const descSafe = Utils.escape(f.descricao);
            return `<div class="flex justify-between py-2 border-b">
                <div>
                    <span class="block">${Utils.formatDate(f.data)} - ${descSafe}</span>
                    ${!f.hora_inicio ? '' : `<span class="text-xs text-orange-500 font-bold">Parcial: ${periodo}</span>`}
                </div>
                <div class="flex gap-2">
                    <button onclick="abrirModalFeriado(${f.id})" class="text-blue-500 p-1"><i data-lucide="edit-2" class="w-4 h-4"></i></button>
                    <button onclick="confirmarExclusao('feriados',${f.id})" class="text-red-500 p-1"><i data-lucide="trash" class="w-4 h-4"></i></button>
                </div>
            </div>`;
        }).join('');
        document.getElementById('listaFeriados').innerHTML = feriadosHtml;
        const folgasHtml = STATE.folgas.map(f => {
            const p = STATE.profissionais.find(x => x.id == (f.professional_id || f.professional));
            const periodo = (!f.hora_inicio) ? 'Dia todo' : `${f.hora_inicio.slice(0,5)} - ${f.hora_fim.slice(0,5)}`;
            return `<div class="grid grid-cols-4 items-center border-b border-slate-50 py-3 text-sm">
                <div class="col-span-2">
                    <span class="font-bold block">${Utils.escape(p ? p.nome : '?')}</span>
                    <span class="text-xs text-slate-500">${Utils.formatDate(f.data)}</span>
                </div>
                <div>${periodo}</div>
                <div class="text-right">
                    <button onclick="abrirModalFolga(${f.id})" class="text-blue-500 mr-2"><i data-lucide="edit-3" class="w-4 h-4"></i></button>
                    <button onclick="confirmarExclusao('folgas-individuais',${f.id})" class="text-red-500"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                </div>
            </div>`;
        }).join('');
        document.getElementById('listaFolgas').innerHTML = folgasHtml;
    }
    function renderHorariosCustom() {
        const container = document.getElementById('lista-horarios-custom');
        let currentData = {};
        try { currentData = JSON.parse(document.getElementById('horarios_custom_json').value); } catch (e) {}
        const diasSemana = ["Segunda", "Terça", "Quarta", "Quinta", "Sexta", "Sábado", "Domingo"];
        const diasFechados = Array.from(document.querySelectorAll('.diaFechado:checked')).map(el => parseInt(el.value));
        const horaAbertura = document.getElementById('horaAbertura').value;
        const horaFechamento = document.getElementById('horaFechamento').value;
        const html = diasSemana.map((dia, index) => {
            if (diasFechados.includes(index)) return '';
            const val = currentData[index] || {};
            const ini = val.inicio || horaAbertura;
            const fim = val.fim || horaFechamento;
            return `
            <div class="flex items-center justify-between bg-slate-50 p-2 rounded-lg text-sm">
                <span class="font-bold text-slate-600 w-24">${dia}</span>
                <div class="flex gap-2">
                    <input type="time" class="hc-inicio input-field !py-1 !text-xs w-24" data-day="${index}" value="${ini}">
                    <span class="self-center text-slate-400">-</span>
                    <input type="time" class="hc-fim input-field !py-1 !text-xs w-24" data-day="${index}" value="${fim}">
                </div>
            </div>`;
        }).join('');
        container.innerHTML = html || '<p class="text-xs text-slate-400 italic">Desmarque dias fechados para configurar horários específicos.</p>';
    }
    // --- 4. CRUD & ACTIONS ---
    // Generic Modal & Tab Handlers
    function switchTab(t) {
        document.querySelectorAll('.tab-content').forEach(e => e.classList.add('hidden'));
        document.getElementById('tab-' + t).classList.remove('hidden');
        document.querySelectorAll('.sidebar-link').forEach(e => e.classList.remove('active'));
        document.getElementById('btn-' + t).classList.add('active');
        history.pushState({}, '', `?tab=${t}`);
    }
    function showToast(m) {
        const x = document.getElementById('toast');
        document.getElementById('toastMsg').innerText = m;
        x.classList.add('show');
        setTimeout(() => x.classList.remove('show'), 3000);
    }
    // Handlers Específicos (Refatorados para usar request centralizado)
    async function salvarProfissional() {
        const id = document.getElementById('mp_id').value;
        const formData = new FormData();
        formData.append('nome', document.getElementById('mp_nome').value);
        formData.append('especialidade', document.getElementById('mp_esp').value);
        formData.append('remover_foto', document.getElementById('mp_remover_foto').value);
        const fileInput = document.getElementById('mp_foto');
        if (fileInput.files[0]) formData.append('foto', fileInput.files[0]);
        const servicos = Array.from(document.querySelectorAll('.mp_servicos:checked')).map(x => x.value);
        formData.append('servicos_ids', JSON.stringify(servicos));
        const escala = {
            dias: Array.from(document.querySelectorAll('.mp_dias:checked')).map(x => parseInt(x.value)),
            inicio: document.getElementById('mp_inicio').value,
            fim: document.getElementById('mp_fim').value
        };
        formData.append('escala', JSON.stringify(escala));
        formData.append('intervalos', JSON.stringify(STATE.intervals));
        const endpoint = id ? `profissionais/${id}` : 'profissionais';
        const method = id ? 'PUT' : 'POST';
        await request(endpoint, method, formData);
        location.reload();
    }
    async function salvarServico() {
        const precoStr = document.getElementById('ms_preco').value;
        const precoFloat = precoStr ? parseFloat(precoStr.replace(/\./g, '').replace(',', '.')) : 0.00;
        let catVal = document.getElementById('ms_cat').value;
        if (!catVal || catVal === "sem-categoria") catVal = null;
        const p = {
            nome: document.getElementById('ms_nome').value,
            preco: precoFloat,
            duracao_minutos: document.getElementById('ms_duracao').value,
            category: catVal
        };
        const id = document.getElementById('ms_id').value;
        await request(id ? `servicos/${id}` : 'servicos', id ? 'PUT' : 'POST', p);
        location.reload();
    }
    // Categorias
    function abrirModalCategorias() {
        document.getElementById('modal-categorias').classList.remove('hidden');
        renderListaCategorias();
        document.getElementById('cat_nome_nova').value = '';
        document.getElementById('cat_id_edicao').value = '';
        document.getElementById('btn-save-cat').innerHTML = '<i data-lucide="plus" class="w-5 h-5"></i>';
        lucide.createIcons();
    }
   
    function renderListaCategorias() {
        document.getElementById('lista_categorias_modal').innerHTML = STATE.categorias.map(c =>
            `<div class="flex justify-between items-center bg-slate-50 p-3 rounded-xl">
                <span class="font-bold text-slate-700">${Utils.escape(c.nome)}</span>
                <div class="flex gap-2">
                    <button onclick="editarCategoria(${c.id}, '${Utils.escape(c.nome)}')" class="text-blue-400 p-1"><i data-lucide="edit-2" class="w-4 h-4"></i></button>
                    <button onclick="confirmarExclusao('categorias',${c.id})" class="text-red-400 p-1"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                </div>
            </div>`
        ).join('');
        lucide.createIcons();
    }
    async function salvarCategoria() {
        const n = document.getElementById('cat_nome_nova').value;
        const id = document.getElementById('cat_id_edicao').value;
        if (n) {
            await request(id ? `categorias/${id}` : 'categorias', id ? 'PUT' : 'POST', { nome: n });
            showToast('Salvo!');
            renderListaCategorias(); // Recarrega lista sem reload da página
             location.reload();
        }
    }
    // Config Geral
    async function salvarConfigGeral() {
        const end = {
            cep: document.getElementById('cep').value,
            logradouro: document.getElementById('logradouro').value,
            numero: document.getElementById('numero').value,
            complemento: document.getElementById('complemento').value,
            bairro: document.getElementById('bairro').value,
            cidade: document.getElementById('cidade').value
        };
        let hCustom = {};
        document.querySelectorAll('.hc-inicio').forEach(inp => {
            const d = inp.dataset.day;
            const inicio = inp.value;
            const fim = document.querySelector(`.hc-fim[data-day="${d}"]`).value;
            const padraoIni = document.getElementById('horaAbertura').value;
            const padraoFim = document.getElementById('horaFechamento').value;
            if (inicio !== padraoIni || fim !== padraoFim) {
                hCustom[d] = { inicio, fim };
            }
        });
        const p = {
            nome: document.getElementById('cfg_nome').value,
            cnpj_cpf: document.getElementById('cfg_doc').value,
            telefone: document.getElementById('cfg_tel').value,
            endereco: JSON.stringify(end),
            hora_abertura_padrao: document.getElementById('horaAbertura').value,
            hora_fechamento_padrao: document.getElementById('horaFechamento').value,
            intervalo_minutos: parseInt(document.getElementById('intervaloMinutos').value),
            dias_fechados: Array.from(document.querySelectorAll('.diaFechado:checked')).map(x => x.value).join(','),
            ocultar_precos: document.getElementById('cfg_ocultar_precos').checked,
            horarios_customizados: hCustom
        };
        await request(`saloes/${CONFIG.SALON_ID}`, 'PUT', p);
        showToast('Configurações Salvas!');
    }
    // --- 5. MODALS & EVENTS ---
   
    // Funções de Exclusão
    function confirmarExclusao(tipo, id) {
        const modal = document.getElementById('modal-confirm-delete');
        const btn = document.getElementById('btn-confirm-delete');
        modal.classList.remove('hidden');
        btn.disabled = false;
        btn.innerText = "Excluir";
        btn.onclick = async function () {
            btn.disabled = true;
            btn.innerText = "Excluindo...";
            try {
                await request(`${tipo}/${id}`, 'DELETE');
                location.reload();
            } catch (e) {
                btn.disabled = false;
                btn.innerText = "Excluir";
                if (e.message.includes("Not Found")) location.reload();
            }
        };
    }
    // Funções de Imagem e Profissional
    function previewImagem(input) {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function (e) {
                document.getElementById('preview-foto').src = e.target.result;
                document.getElementById('preview-foto').classList.remove('hidden');
                document.getElementById('icon-camera').classList.add('hidden');
                document.getElementById('mp_remover_foto').value = 'false';
            }
            reader.readAsDataURL(input.files[0]);
        }
    }
    function abrirModalProfissional(id = null) {
        const p = id ? STATE.profissionais.find(x => x.id == id) : null;
        document.getElementById('modal-profissional').classList.remove('hidden');
        document.getElementById('mp_id').value = id || '';
        document.getElementById('mp_nome').value = p ? p.nome : '';
        document.getElementById('mp_esp').value = p ? p.especialidade : '';
        // Reset Imagem
        document.getElementById('mp_foto').value = "";
        document.getElementById('mp_remover_foto').value = "false";
        if (p && p.foto_url) {
            document.getElementById('preview-foto').src = p.foto_url;
            document.getElementById('preview-foto').classList.remove('hidden');
            document.getElementById('icon-camera').classList.add('hidden');
            document.getElementById('btn-remover-foto').classList.remove('hidden');
        } else {
            removerFoto();
            document.getElementById('btn-remover-foto').classList.add('hidden');
        }
        STATE.intervals = p ? [...p.intervalos] : [];
        renderIntervalos();
       
        const box = document.getElementById('mp_lista_servicos');
        box.innerHTML = '';
        const renderChkGroup = (t, l) => {
            if (!l.length) return '';
            const items = l.map(s => `
                <label class="cursor-pointer relative block group h-full">
                    <input type="checkbox" class="mp_servicos check-card peer absolute opacity-0 w-full h-full inset-0 z-10 cursor-pointer" value="${s.id}" ${p && p.servicos_ids.includes(s.id) ? 'checked' : ''}>
                    <div class="p-3 rounded-xl border border-slate-200 bg-white text-sm font-semibold text-slate-600 transition-all h-full flex items-center justify-center text-center group-hover:border-theme/50 peer-checked:bg-theme peer-checked:text-white peer-checked:border-theme">
                        ${Utils.escape(s.nome)}
                    </div>
                </label>`).join('');
            return `<div class="bg-slate-50 p-3 rounded-xl border border-slate-100"><h5 class="text-xs font-bold text-slate-500 uppercase mb-2 ml-1">${Utils.escape(t)}</h5><div class="grid grid-cols-2 sm:grid-cols-3 gap-3">${items}</div></div>`;
        };
       
        STATE.categorias.forEach(c => box.innerHTML += renderChkGroup(c.nome, STATE.servicos.filter(s => s.category_id == c.id)));
        box.innerHTML += renderChkGroup("Outros", STATE.servicos.filter(s => !s.category_id));
       
        document.querySelectorAll('.mp_dias').forEach(c => c.checked = false);
        if (p && p.escala.length) {
            document.getElementById('mp_inicio').value = p.escala[0].start;
            document.getElementById('mp_fim').value = p.escala[0].end;
            p.escala.forEach(e => document.querySelector(`.mp_dias[value="${e.day}"]`).checked = true);
        }
    }
    function removerFoto() {
        document.getElementById('mp_foto').value = "";
        document.getElementById('preview-foto').src = "";
        document.getElementById('preview-foto').classList.add('hidden');
        document.getElementById('icon-camera').classList.remove('hidden');
        document.getElementById('btn-remover-foto').classList.add('hidden');
        document.getElementById('mp_remover_foto').value = 'true';
    }
    function addIntervalo() {
        const i = document.getElementById('mp_int_ini').value;
        const f = document.getElementById('mp_int_fim').value;
        if (i && f) {
            STATE.intervals.push({ start: i, end: f });
            renderIntervalos();
        }
    }
   
    function renderIntervalos() {
        document.getElementById('lista_intervalos').innerHTML = STATE.intervals.map((x, i) =>
            `<div class="flex justify-between items-center bg-white border p-2 rounded text-sm">
                <span>${x.start} - ${x.end}</span>
                <button onclick="STATE.intervals.splice(${i},1);renderIntervalos()" class="text-red-500"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
            </div>`
        ).join('');
        lucide.createIcons();
    }
    // Funções Helpers de UI
    function abrirModalServico(id = null) {
        const s = id ? STATE.servicos.find(x => x.id == id) : null;
        document.getElementById('modal-servico').classList.remove('hidden');
        document.getElementById('ms_id').value = id || '';
        document.getElementById('ms_nome').value = s ? s.nome : '';
        document.getElementById('ms_preco').value = s ? Utils.formatCurrency(s.preco) : '';
        document.getElementById('ms_duracao').value = s ? s.duracao_minutos : '';
        const sel = document.getElementById('ms_cat');
        sel.innerHTML = '<option value="">Sem Categoria</option>' +
            STATE.categorias.map(c => `<option value="${c.id}" ${s && s.category_id == c.id ? 'selected' : ''}>${Utils.escape(c.nome)}</option>`).join('');
    }
    // --- 6. REALTIME & INIT ---
    function iniciarEscutaRealTime() {
        if (typeof (EventSource) !== "undefined") {
            STATE.eventSource = new EventSource(`${CONFIG.API_BASE}/events/stream`);
            STATE.eventSource.onmessage = async function (event) {
                if (event.data === "update") {
                    const urlParams = new URLSearchParams(window.location.search);
                    if ((urlParams.get('tab') || 'agenda') === 'agenda' && !document.hidden) {
                        try {
                            const response = await fetch(`${CONFIG.API_BASE}/partials/agendamentos`);
                            if (response.ok) {
                                document.getElementById('tabelaAgendamentos').innerHTML = await response.text();
                                filtrarAgenda();
                                lucide.createIcons();
                            }
                        } catch (e) { console.warn("SSE Partial Error", e); }
                    }
                }
            };
        }
    }
    // Inicialização
    window.addEventListener('DOMContentLoaded', () => {
        renderServicos();
        renderProfissionais();
        renderListasAusencias();
       
        // Popula filtro de profissionais
        const selFiltro = document.getElementById('filtroProfissional');
        STATE.profissionais.forEach(p => selFiltro.innerHTML += `<option value="${p.id}">${Utils.escape(p.nome)}</option>`);
        // Popula endereço
        try {
            const e = JSON.parse(document.getElementById('endereco_full').value);
            document.getElementById('cep').value = e.cep || '';
            document.getElementById('logradouro').value = e.logradouro || '';
            document.getElementById('numero').value = e.numero || '';
            document.getElementById('complemento').value = e.complemento || '';
            document.getElementById('bairro').value = e.bairro || '';
            document.getElementById('cidade').value = e.cidade || '';
        } catch (e) {}
        // Marca dias fechados
        "{{ salao.dias_fechados }}".split(',').forEach(d => {
            const cb = document.querySelector(`.diaFechado[value="${d}"]`);
            if (cb) cb.checked = true;
        });
        // Event Listeners Globais
        document.querySelectorAll('.diaFechado').forEach(cb => cb.addEventListener('change', renderHorariosCustom));
        renderHorariosCustom();
        // QRCode
        new QRCode(document.getElementById("qrcode"), {
            text: `${window.location.origin}/agendar/${CONFIG.SALON_SLUG}`,
            width: 64, height: 64
        });
        lucide.createIcons();
       
        const urlParams = new URLSearchParams(window.location.search);
        switchTab(urlParams.get('tab') || 'agenda');
       
        iniciarEscutaRealTime();
    });
    // Funções de Apoio (Mantidas no escopo global para o onclick do HTML funcionar)
    function filtrarAgenda() {
        const dt = document.getElementById('filtroData').value;
        const pr = document.getElementById('filtroProfissional').value;
        let c = 0;
        document.querySelectorAll('.linha-agendamento').forEach(r => {
            const md = !dt || r.dataset.date == dt;
            const mp = !pr || r.dataset.prof == pr;
            if (md && mp) { r.style.display = ''; c++; } else r.style.display = 'none';
        });
        document.getElementById('msgSemResultados').classList.toggle('hidden', c > 0);
    }
    function limparFiltros(){ document.getElementById('filtroData').value=''; document.getElementById('filtroProfissional').value=''; filtrarAgenda(); }
   
    // Máscaras (Simplificadas)
    function mascaraDoc(i){ i.value = i.value.replace(/\D/g,"").replace(/^(\d{2})(\d{3})(\d{3})(\d{4})(\d{2})/, "$1.$2.$3/$4-$5").slice(0, 18); }
    function mascaraTel(i){ let v=i.value.replace(/\D/g,""); v=v.replace(/^(\d{2})(\d{5})(\d{4})/,"($1) $2-$3"); i.value=v.slice(0, 15); }
    function mascaraCep(i){ i.value = i.value.replace(/\D/g,"").replace(/^(\d{5})(\d)/,"$1-$2").slice(0, 9); }
    function mascaraMoeda(i) { let v = i.value.replace(/\D/g,''); v = (v/100).toFixed(2) + ''; v = v.replace(".", ","); v = v.replace(/(\d)(\d{3})(\d{3}),/g, "$1.$2.$3,"); i.value = v; }
   
    // Handlers de Modal (Simples)
    function fecharModalDelete(){ document.getElementById('modal-confirm-delete').classList.add('hidden'); }
    function fecharModalCategorias(){ document.getElementById('modal-categorias').classList.add('hidden'); location.reload(); }
    function fecharModalErro() { document.getElementById('modal-erro-api').classList.add('hidden'); }
    function mostrarErroApi(msg) { document.getElementById('msg-erro-api').innerText = msg; document.getElementById('modal-erro-api').classList.remove('hidden'); }
    function editarCategoria(id, n){ document.getElementById('cat_id_edicao').value=id; document.getElementById('cat_nome_nova').value=n; document.getElementById('btn-save-cat').innerHTML='<i data-lucide="check" class="w-5 h-5"></i>'; lucide.createIcons(); }
    function mudarCor(c){ request(`saloes/${CONFIG.SALON_ID}`, 'PUT', {cor_do_tema:c}).then(()=>location.reload()); }
    function copiarLink(){ navigator.clipboard.writeText(`${window.location.origin}/agendar/${CONFIG.SALON_SLUG}`); showToast('Link copiado!'); }
    function abrirModalLogout(){ document.getElementById('modal-logout').classList.remove('hidden'); }
   
    // Funções de Ausência (Feriado/Folga)
    function abrirModalFeriado(id=null){
        const f = id ? STATE.feriados.find(x=>x.id==id) : null;
        document.getElementById('modal-feriado').classList.remove('hidden');
        document.getElementById('titulo-modal-feriado').innerText = f ? 'Editar Feriado' : 'Novo Feriado';
        document.getElementById('mf_id').value = f ? f.id : '';
        document.getElementById('mf_data').value = f ? f.data : '';
        document.getElementById('mf_desc').value = f ? f.descricao : '';
        const diaTodo = !f || !f.hora_inicio;
        document.getElementById('mf_diatodo').checked = diaTodo;
        if(!diaTodo){ document.getElementById('mf_ini').value = f.hora_inicio; document.getElementById('mf_fim').value = f.hora_fim; }
        else { document.getElementById('mf_ini').value = ''; document.getElementById('mf_fim').value = ''; }
        toggleFeriadoDiaTodo();
    }
    function toggleFeriadoDiaTodo(){ const c = document.getElementById('mf_diatodo').checked; const div = document.getElementById('container-horas-feriado'); if(c) div.classList.add('opacity-50','pointer-events-none'); else div.classList.remove('opacity-50','pointer-events-none'); }
    async function salvarNovoFeriado(){
        const dt = document.getElementById('mf_diatodo').checked;
        const p = { data: document.getElementById('mf_data').value, descricao: document.getElementById('mf_desc').value, hora_inicio: dt ? null : document.getElementById('mf_ini').value, hora_fim: dt ? null : document.getElementById('mf_fim').value };
        const id = document.getElementById('mf_id').value;
        await request(id ? `feriados/${id}` : 'feriados', id ? 'PUT' : 'POST', p);
        location.reload();
    }
    function abrirModalFolga(id=null){
        const f = id ? STATE.folgas.find(x=>x.id==id) : null;
        document.getElementById('modal-folga').classList.remove('hidden'); document.getElementById('titulo-modal-folga').innerText=f?'Editar Folga':'Nova Folga';
        const sel=document.getElementById('mfo_prof'); sel.innerHTML='<option value="">Selecione...</option>' + STATE.profissionais.map(p=>`<option value="${p.id}" ${f&&f.professional==p.id?'selected':''}>${Utils.escape(p.nome)}</option>`).join('');
        document.getElementById('mfo_id').value=f?f.id:''; document.getElementById('mfo_data').value=f?f.data:'';
        const diaTodo = !f || !f.hora_inicio;
        document.getElementById('mfo_diatodo').checked=diaTodo; toggleFolgaDiaTodo();
        if(!diaTodo){ document.getElementById('mfo_ini').value=f.hora_inicio; document.getElementById('mfo_fim').value=f.hora_fim; }
    }
    function toggleFolgaDiaTodo(){ const c=document.getElementById('mfo_diatodo').checked, div=document.getElementById('container-horas-folga'); if(c) div.classList.add('opacity-50','pointer-events-none'); else div.classList.remove('opacity-50','pointer-events-none'); }
    async function salvarNovaFolga(){ const dt=document.getElementById('mfo_diatodo').checked; const p={professional:document.getElementById('mfo_prof').value, data:document.getElementById('mfo_data').value, hora_inicio:dt?null:document.getElementById('mfo_ini').value, hora_fim:dt?null:document.getElementById('mfo_fim').value}, id=document.getElementById('mfo_id').value; await request(id ? `folgas-individuais/${id}` : 'folgas-individuais', id ? 'PUT' : 'POST', p); location.reload(); }
   
    // Busca CEP
    async function buscarCep(){
        const cep=document.getElementById('cep').value.replace(/\D/g,'');
        if(cep.length===8){
            try{
                const r=await fetch(`https://viacep.com.br/ws/${cep}/json/`);
                const d=await r.json();
                if(!d.erro){
                    document.getElementById('logradouro').value=d.logradouro;
                    document.getElementById('bairro').value=d.bairro;
                    document.getElementById('cidade').value=`${d.localidade}/${d.uf}`;
                }
            }catch(e){}
        }
    }
</script>
</body>
</html>